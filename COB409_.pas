{
select * from APO101 where (USEID='BB' and UPAGOID='B0' and UPROID='HUA') or USEID='BB'
select * from APO101 where (USEID='B3' and UPAGOID='B0' and UPROID='HUA') or USEID='B3'
select * from APO101 where (USEID='B5' and UPAGOID='B0' and UPROID='HUA') or USEID='B5'
select * from APO101 where (USEID='B6' and UPAGOID='B0' and UPROID='HUA') or USEID='B6'
select * from APO101 where (USEID='C5' and UPAGOID='C5' and UPROID='NOM') or USEID='C5'
select * from APO101 where (USEID='DA' and UPAGOID='DB' and UPROID='ARE') or USEID='DA'
select * from APO101 where (USEID='DA' and UPAGOID='D0' and UPROID='PAS') or USEID='DA'
select * from APO101 where (USEID='DC' and UPAGOID='DB' and UPROID='ARE') or USEID='DC'
select * from APO101 where (USEID='DD' and UPAGOID='DB' and UPROID='ARE') or USEID='DD'
select * from APO101 where (USEID='DE' and UPAGOID='DB' and UPROID='ARE') or USEID='DE'
select * from APO101 where (USEID='DF' and UPAGOID='DB' and UPROID='ARE') or USEID='DF'
select * from APO101 where (USEID='DG' and UPAGOID='DB' and UPROID='ARE') or USEID='DG'
select * from APO101 where (USEID='DH' and UPAGOID='DB' and UPROID='ARE') or USEID='DH'
select * from APO101 where (USEID='DI' and UPAGOID='DB' and UPROID='ARE') or USEID='DI'
select * from APO101 where (USEID='DJ' and UPAGOID='DB' and UPROID='ARE') or USEID='DJ'
select * from APO101 where (USEID='G-' and UPAGOID='2-' and UPROID='PUN') or USEID='G-'
select * from APO101 where (USEID='G-' and UPAGOID='6A' and UPROID='PUN') or USEID='G-'
select * from APO101 where (USEID='GB' and UPAGOID='G5' and UPROID='AYA') or USEID='GB'
select * from APO101 where (USEID='H0' and UPAGOID='H3' and UPROID='HVC') or USEID='H0'
select * from APO101 where (USEID='H3' and UPAGOID='H3' and UPROID='HVC') or USEID='H3'
select * from APO101 where (USEID='H6' and UPAGOID='H3' and UPROID='HVC') or USEID='H6'
select * from APO101 where (USEID='KA' and UPAGOID='K0' and UPROID='AND') or USEID='KA'
select * from APO101 where (USEID='LG' and UPAGOID='L0' and UPROID='HUZ') or USEID='LG'
select * from APO101 where (USEID='LH' and UPAGOID='LH' and UPROID='HUZ') or USEID='LH'
select * from APO101 where (USEID='LJ' and UPAGOID='LH' and UPROID='HUZ') or USEID='LJ'
select * from APO101 where (USEID='S0' and UPAGOID='S0' and UPROID='MED') or USEID='S0'
select * from APO101 where (USEID='T2' and UPAGOID='1-' and UPROID='TAC') or USEID='T2'
select * from APO101 where (USEID='U1' and UPAGOID='0E' and UPROID='MED') or USEID='U1'
select * from APO101 where (USEID='0C' and UPAGOID='0F' and UPROID='MED') or USEID='0C'
select * from APO101 where (USEID='0E' and UPAGOID='0F' and UPROID='MED') or USEID='0E'
select * from APO101 where (USEID='0I' and UPAGOID='A6' and UPROID='AMA') or USEID='0I'
select * from APO101 where (USEID='0K' and UPAGOID='A6' and UPROID='AMA') or USEID='0K'
select * from APO101 where (USEID='0K' and UPAGOID='52' and UPROID='AMA') or USEID='0K'
select * from APO101 where (USEID='0L' and UPAGOID='A2' and UPROID='AMA') or USEID='0L'
select * from APO101 where (USEID='0L' and UPAGOID='A6' and UPROID='AMA') or USEID='0L'
select * from APO101 where (USEID='0M' and UPAGOID='A6' and UPROID='AMA') or USEID='0M'
select * from APO101 where (USEID='10' and UPAGOID='0F' and UPROID='NOM') or USEID='10'
select * from APO101 where (USEID='3A' and UPAGOID='30' and UPROID='JUN') or USEID='3A'
select * from APO101 where (USEID='3C' and UPAGOID='H3' and UPROID='JUN') or USEID='3C'
select * from APO101 where (USEID='3F' and UPAGOID='30' and UPROID='JUN') or USEID='3F'
select * from APO101 where (USEID='3G' and UPAGOID='30' and UPROID='JUN') or USEID='3G'
select * from APO101 where (USEID='3X' and UPAGOID='30' and UPROID='JUN') or USEID='3X'
select * from APO101 where (USEID='30' and UPAGOID='H3' and UPROID='JUN') or USEID='30'
select * from APO101 where (USEID='30' and UPAGOID='3A' and UPROID='JUN') or USEID='30'
select * from APO101 where (USEID='32' and UPAGOID='30' and UPROID='JUN') or USEID='32'
select * from APO101 where (USEID='5A' and UPAGOID='5A' and UPROID='CUS') or USEID='5A'
select * from APO101 where (USEID='5A' and UPAGOID='50' and UPROID='CUS') or USEID='5A'
select * from APO101 where (USEID='5B' and UPAGOID='50' and UPROID='CUS') or USEID='5B'
select * from APO101 where (USEID='5B' and UPAGOID='54' and UPROID='CUS') or USEID='5B'
select * from APO101 where (USEID='5C' and UPAGOID='5G' and UPROID='CUS') or USEID='5C'
select * from APO101 where (USEID='5C' and UPAGOID='50' and UPROID='CUS') or USEID='5C'
select * from APO101 where (USEID='5D' and UPAGOID='50' and UPROID='CUS') or USEID='5D'
select * from APO101 where (USEID='5D' and UPAGOID='54' and UPROID='CUS') or USEID='5D'
select * from APO101 where (USEID='5E' and UPAGOID='5G' and UPROID='CUS') or USEID='5E'
select * from APO101 where (USEID='5E' and UPAGOID='50' and UPROID='CUS') or USEID='5E'
select * from APO101 where (USEID='5E' and UPAGOID='50' and UPROID='QUP') or USEID='5E'
select * from APO101 where (USEID='5G' and UPAGOID='5G' and UPROID='CUS') or USEID='5G'
select * from APO101 where (USEID='5G' and UPAGOID='50' and UPROID='CUS') or USEID='5G'
select * from APO101 where (USEID='5L' and UPAGOID='50' and UPROID='CUS') or USEID='5L'
select * from APO101 where (USEID='54' and UPAGOID='50' and UPROID='CUS') or USEID='54'
select * from APO101 where (USEID='54' and UPAGOID='54' and UPROID='CUS') or USEID='54'
select * from APO101 where (USEID='6A' and UPAGOID='6A' and UPROID='LOR') or USEID='6A'
select * from APO101 where (USEID='6B' and UPAGOID='6B' and UPROID='LOR') or USEID='6B'
select * from APO101 where (USEID='6C' and UPAGOID='6C' and UPROID='LOR') or USEID='6C'

select 'BB' USEID, 'B0' UPAGOID, 'HUA' UPROID from TGE901

select 'BB' USEID, 'B0' UPAGOID, 'HUA' UPROID from TGE901
union all select 'B3' USEID, 'B0' UPAGOID, 'HUA' UPROID from TGE901
union all select 'B5' USEID, 'B0' UPAGOID, 'HUA' UPROID from TGE901
union all select 'B6' USEID, 'B0' UPAGOID, 'HUA' UPROID from TGE901
union all select 'C5' USEID, 'C5' UPAGOID, 'NOM' UPROID from TGE901
union all select 'DA' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DA' USEID, 'D0' UPAGOID, 'PAS' UPROID from TGE901
union all select 'DC' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DD' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DE' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DF' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DG' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DH' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DI' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'DJ' USEID, 'DB' UPAGOID, 'ARE' UPROID from TGE901
union all select 'G-' USEID, '2-' UPAGOID, 'PUN' UPROID from TGE901
union all select 'G-' USEID, '6A' UPAGOID, 'PUN' UPROID from TGE901
union all select 'GB' USEID, 'G5' UPAGOID, 'AYA' UPROID from TGE901
union all select 'H0' USEID, 'H3' UPAGOID, 'HVC' UPROID from TGE901
union all select 'H3' USEID, 'H3' UPAGOID, 'HVC' UPROID from TGE901
union all select 'H6' USEID, 'H3' UPAGOID, 'HVC' UPROID from TGE901
union all select 'KA' USEID, 'K0' UPAGOID, 'AND' UPROID from TGE901
union all select 'LG' USEID, 'L0' UPAGOID, 'HUZ' UPROID from TGE901
union all select 'LH' USEID, 'LH' UPAGOID, 'HUZ' UPROID from TGE901
union all select 'LJ' USEID, 'LH' UPAGOID, 'HUZ' UPROID from TGE901
union all select 'S0' USEID, 'S0' UPAGOID, 'MED' UPROID from TGE901
union all select 'T2' USEID, '1-' UPAGOID, 'TAC' UPROID from TGE901
union all select 'U1' USEID, '0E' UPAGOID, 'MED' UPROID from TGE901
union all select '0C' USEID, '0F' UPAGOID, 'MED' UPROID from TGE901
union all select '0E' USEID, '0F' UPAGOID, 'MED' UPROID from TGE901
union all select '0I' USEID, 'A6' UPAGOID, 'AMA' UPROID from TGE901
union all select '0K' USEID, 'A6' UPAGOID, 'AMA' UPROID from TGE901
union all select '0K' USEID, '52' UPAGOID, 'AMA' UPROID from TGE901
union all select '0L' USEID, 'A2' UPAGOID, 'AMA' UPROID from TGE901
union all select '0L' USEID, 'A6' UPAGOID, 'AMA' UPROID from TGE901
union all select '0M' USEID, 'A6' UPAGOID, 'AMA' UPROID from TGE901
union all select '10' USEID, '0F' UPAGOID, 'NOM' UPROID from TGE901
union all select '3A' USEID, '30' UPAGOID, 'JUN' UPROID from TGE901
union all select '3C' USEID, 'H3' UPAGOID, 'JUN' UPROID from TGE901
union all select '3F' USEID, '30' UPAGOID, 'JUN' UPROID from TGE901
union all select '3G' USEID, '30' UPAGOID, 'JUN' UPROID from TGE901
union all select '3X' USEID, '30' UPAGOID, 'JUN' UPROID from TGE901
union all select '30' USEID, 'H3' UPAGOID, 'JUN' UPROID from TGE901
union all select '30' USEID, '3A' UPAGOID, 'JUN' UPROID from TGE901
union all select '32' USEID, '30' UPAGOID, 'JUN' UPROID from TGE901
union all select '5A' USEID, '5A' UPAGOID, 'CUS' UPROID from TGE901
union all select '5A' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5B' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5B' USEID, '54' UPAGOID, 'CUS' UPROID from TGE901
union all select '5C' USEID, '5G' UPAGOID, 'CUS' UPROID from TGE901
union all select '5C' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5D' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5D' USEID, '54' UPAGOID, 'CUS' UPROID from TGE901
union all select '5E' USEID, '5G' UPAGOID, 'CUS' UPROID from TGE901
union all select '5E' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5E' USEID, '50' UPAGOID, 'QUP' UPROID from TGE901
union all select '5G' USEID, '5G' UPAGOID, 'CUS' UPROID from TGE901
union all select '5G' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '5L' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '54' USEID, '50' UPAGOID, 'CUS' UPROID from TGE901
union all select '54' USEID, '54' UPAGOID, 'CUS' UPROID from TGE901
union all select '6A' USEID, '6A' UPAGOID, 'LOR' UPROID from TGE901
union all select '6B' USEID, '6B' UPAGOID, 'LOR' UPROID from TGE901
union all select '6C' USEID, '6C' UPAGOID, 'LOR' UPROID from TGE901
}
unit COB409;

interface

uses

  Windows, Messages, SysUtils, Classes, StdCtrls, Controls, ExtCtrls,
  ppBands, ppReport, ppStrtch, ppSubRpt, ppParameter, ppClass, ppCtrls,
  ppVar, ppDB, ppDBPipe, ppDBBDE, ppPrnabl, ppCache, ppComm, ppRelatv,
  ppProd, ComCtrls, Grids, Wwdbigrd, Wwdbgrid, Buttons, Mask,dialogs,
  wwdbedit, Wwdbspin, fcButton, fcImgBtn, fcShapeBtn, Forms, variants,
  ppEndUsr;
           {
  fcLabel,
  Buttons, ToolWin, Forms, wwDBigrd, DB, Mant, dialogs, ppCtrls,
  DBCtrls, IniFiles, ACC005, ACC002, ACC003, Grids, DBGrids, Wwdbgrid, Graphics;
            }
type
  TFContabilizacion = class(TForm)
    pnlCabecera: TPanel;
    fcShapeBtn2: TfcShapeBtn;
    Panel1: TPanel;
    GroupBox1: TGroupBox;
    dbseMes: TwwDBSpinEdit;
    dbseAno: TwwDBSpinEdit;
    PageControl1: TPageControl;
    edtFecha: TEdit;
    TabSheet4: TTabSheet;
    fcShapeBtn6: TfcShapeBtn;
    TabSheet5: TTabSheet;
    TabSheet6: TTabSheet;
    TabSheet7: TTabSheet;
    ppReport2: TppReport;
    ppHeaderBand2: TppHeaderBand;
    ppLabel6: TppLabel;
    ppLabel7: TppLabel;
    ppLabel8: TppLabel;
    ppLabel9: TppLabel;
    ppLabel10: TppLabel;
    ppLabel11: TppLabel;
    ppLabel12: TppLabel;
    ppLabel13: TppLabel;
    ppLine3: TppLine;
    ppDetailBand2: TppDetailBand;
    ppDBText5: TppDBText;
    ppDBText6: TppDBText;
    ppDBText7: TppDBText;
    ppDBText9: TppDBText;
    ppDBText10: TppDBText;
    ppDBText11: TppDBText;
    ppDBText12: TppDBText;
    ppDBText8: TppDBText;
    ppSummaryBand2: TppSummaryBand;
    ppDBCalc3: TppDBCalc;
    ppDBCalc4: TppDBCalc;
    ppDBCalc5: TppDBCalc;
    ppDBCalc6: TppDBCalc;
    ppDBCalc7: TppDBCalc;
    ppLine4: TppLine;
    ppBDEPipeline2: TppBDEPipeline;
    ppReport1: TppReport;
    ppHeaderBand1: TppHeaderBand;
    ppLabel1: TppLabel;
    ppLabel2: TppLabel;
    ppLabel3: TppLabel;
    ppLine2: TppLine;
    ppLabel4: TppLabel;
    ppLabel5: TppLabel;
    ppSystemVariable1: TppSystemVariable;
    ppDetailBand1: TppDetailBand;
    ppDBText1: TppDBText;
    ppDBText2: TppDBText;
    ppDBText3: TppDBText;
    ppDBText4: TppDBText;
    ppSummaryBand1: TppSummaryBand;
    ppDBCalc1: TppDBCalc;
    ppDBCalc2: TppDBCalc;
    ppLine1: TppLine;
    ppBDEPipeline1: TppBDEPipeline;
    BDEPPBANCO: TppBDEPipeline;
    REPBANCO: TppReport;
    ppHeaderBand3: TppHeaderBand;
    ppShape4: TppShape;
    ppLabel18: TppLabel;
    ppSystemVariable2: TppSystemVariable;
    ppSystemVariable3: TppSystemVariable;
    ppLabel19: TppLabel;
    ppLabel20: TppLabel;
    ppLabel21: TppLabel;
    ppXtitulo: TppLabel;
    ppDetailBand3: TppDetailBand;
    ppDBText17: TppDBText;
    ppDBText18: TppDBText;
    ppDBText20: TppDBText;
    ppDBText21: TppDBText;
    ppDBText22: TppDBText;
    ppDBText23: TppDBText;
    ppDBText24: TppDBText;
    ppDBText25: TppDBText;
    ppDBText26: TppDBText;
    ppDBText27: TppDBText;
    ppLine5: TppLine;
    ppLine6: TppLine;
    ppLine7: TppLine;
    ppLine8: TppLine;
    ppLine9: TppLine;
    ppLine10: TppLine;
    ppLine11: TppLine;
    ppLine12: TppLine;
    ppLine13: TppLine;
    ppLine14: TppLine;
    ppDBText28: TppDBText;
    ppDBText29: TppDBText;
    ppDBText30: TppDBText;
    ppLine15: TppLine;
    ppLine16: TppLine;
    ppLine18: TppLine;
    ppFooterBand1: TppFooterBand;
    ppShape7: TppShape;
    ppLabel24: TppLabel;
    ppDBCalc23: TppDBCalc;
    ppDBCalc24: TppDBCalc;
    ppDBCalc25: TppDBCalc;
    ppDBCalc26: TppDBCalc;
    ppDBCalc27: TppDBCalc;
    ppGroup3: TppGroup;
    ppGroupHeaderBand3: TppGroupHeaderBand;
    ppShape1: TppShape;
    ppDBText32: TppDBText;
    ppXsubtitulo: TppLabel;
    ppGroupFooterBand3: TppGroupFooterBand;
    ppShape6: TppShape;
    ppLabel23: TppLabel;
    ppDBCalc18: TppDBCalc;
    ppDBCalc19: TppDBCalc;
    ppDBCalc20: TppDBCalc;
    ppDBCalc21: TppDBCalc;
    ppDBText34: TppDBText;
    ppDBCalc22: TppDBCalc;
    ppGroup1: TppGroup;
    ppGroupHeaderBand1: TppGroupHeaderBand;
    ppShape2: TppShape;
    ppDBText13: TppDBText;
    ppDBText15: TppDBText;
    ppGroupFooterBand1: TppGroupFooterBand;
    ppShape5: TppShape;
    ppLabel22: TppLabel;
    ppDBText33: TppDBText;
    ppDBCalc13: TppDBCalc;
    ppDBCalc14: TppDBCalc;
    ppDBCalc15: TppDBCalc;
    ppDBCalc16: TppDBCalc;
    ppDBCalc17: TppDBCalc;
    ppGroup2: TppGroup;
    ppGroupHeaderBand2: TppGroupHeaderBand;
    ppDBText14: TppDBText;
    ppDBText16: TppDBText;
    ppDBText19: TppDBText;
    ppLine17: TppLine;
    ppGroupFooterBand2: TppGroupFooterBand;
    ppShape3: TppShape;
    ppLabel15: TppLabel;
    ppDBText31: TppDBText;
    ppDBCalc8: TppDBCalc;
    ppDBCalc9: TppDBCalc;
    ppDBCalc10: TppDBCalc;
    ppDBCalc11: TppDBCalc;
    ppDBCalc12: TppDBCalc;
    REPPLA: TppReport;
    ppHeaderBand4: TppHeaderBand;
    ppShape8: TppShape;
    ppLabel16: TppLabel;
    ppSystemVariable4: TppSystemVariable;
    ppSystemVariable5: TppSystemVariable;
    ppLabel17: TppLabel;
    ppLabel25: TppLabel;
    ppLabel26: TppLabel;
    XTITULO3: TppLabel;
    ppDetailBand4: TppDetailBand;
    ppDBText35: TppDBText;
    ppDBText36: TppDBText;
    ppDBText37: TppDBText;
    ppDBText38: TppDBText;
    ppDBText39: TppDBText;
    ppDBText40: TppDBText;
    ppDBText41: TppDBText;
    ppDBText42: TppDBText;
    ppDBText43: TppDBText;
    ppDBText44: TppDBText;
    ppLine19: TppLine;
    ppLine20: TppLine;
    ppLine21: TppLine;
    ppLine22: TppLine;
    ppLine23: TppLine;
    ppLine24: TppLine;
    ppLine25: TppLine;
    ppLine26: TppLine;
    ppLine27: TppLine;
    ppLine28: TppLine;
    ppDBText45: TppDBText;
    ppDBText46: TppDBText;
    ppDBText47: TppDBText;
    ppLine29: TppLine;
    ppLine30: TppLine;
    ppLine31: TppLine;
    ppDBText59: TppDBText;
    ppLine33: TppLine;
    ppSummaryBand3: TppSummaryBand;
    ppShape9: TppShape;
    ppDBCalc28: TppDBCalc;
    ppDBCalc29: TppDBCalc;
    ppDBCalc30: TppDBCalc;
    ppDBCalc31: TppDBCalc;
    ppDBCalc32: TppDBCalc;
    ppLabel28: TppLabel;
    ppGroup6: TppGroup;
    ppGroupHeaderBand6: TppGroupHeaderBand;
    ppShape16: TppShape;
    ppDBText57: TppDBText;
    ppGroupFooterBand6: TppGroupFooterBand;
    ppShape14: TppShape;
    ppDBCalc43: TppDBCalc;
    ppDBCalc44: TppDBCalc;
    ppDBCalc45: TppDBCalc;
    ppDBCalc46: TppDBCalc;
    ppDBCalc47: TppDBCalc;
    ppLabel33: TppLabel;
    ppDBText58: TppDBText;
    ppGroup7: TppGroup;
    ppGroupHeaderBand7: TppGroupHeaderBand;
    ppShape10: TppShape;
    XSUBTITULO3: TppLabel;
    ppDBText48: TppDBText;
    ppGroupFooterBand7: TppGroupFooterBand;
    ppShape15: TppShape;
    ppDBCalc48: TppDBCalc;
    ppDBCalc49: TppDBCalc;
    ppDBCalc50: TppDBCalc;
    ppDBCalc51: TppDBCalc;
    ppDBCalc52: TppDBCalc;
    ppLabel30: TppLabel;
    ppDBText49: TppDBText;
    ppGroup4: TppGroup;
    ppGroupHeaderBand4: TppGroupHeaderBand;
    ppShape12: TppShape;
    ppDBText50: TppDBText;
    ppDBText51: TppDBText;
    ppGroupFooterBand4: TppGroupFooterBand;
    ppShape11: TppShape;
    ppDBCalc33: TppDBCalc;
    ppDBCalc34: TppDBCalc;
    ppDBCalc35: TppDBCalc;
    ppDBCalc36: TppDBCalc;
    ppDBCalc37: TppDBCalc;
    ppLabel31: TppLabel;
    ppDBText52: TppDBText;
    ppGroup5: TppGroup;
    ppGroupHeaderBand5: TppGroupHeaderBand;
    ppDBText53: TppDBText;
    ppDBText54: TppDBText;
    ppDBText55: TppDBText;
    ppLine32: TppLine;
    ppGroupFooterBand5: TppGroupFooterBand;
    ppShape13: TppShape;
    ppDBCalc38: TppDBCalc;
    ppDBCalc39: TppDBCalc;
    ppDBCalc40: TppDBCalc;
    ppDBCalc41: TppDBCalc;
    ppDBCalc42: TppDBCalc;
    ppLabel32: TppLabel;
    ppDBText56: TppDBText;
    DBPBANCOS: TppBDEPipeline;
    ppBDEPPBANCO: TppReport;
    ppHeaderBand6: TppHeaderBand;
    ppShape24: TppShape;
    ppLabel50: TppLabel;
    ppLabel51: TppLabel;
    ppSystemVariable8: TppSystemVariable;
    ppSystemVariable9: TppSystemVariable;
    ppLabel52: TppLabel;
    ppLabel53: TppLabel;
    ppLabel54: TppLabel;
    ppDetailBand7: TppDetailBand;
    ppDBText77: TppDBText;
    ppDBText78: TppDBText;
    ppDBText79: TppDBText;
    ppDBText80: TppDBText;
    ppDBText81: TppDBText;
    ppDBText82: TppDBText;
    ppDBText83: TppDBText;
    ppDBText84: TppDBText;
    ppDBText85: TppDBText;
    ppDBText86: TppDBText;
    ppDBText87: TppDBText;
    ppDBText88: TppDBText;
    ppDBText89: TppDBText;
    ppLine66: TppLine;
    ppLine67: TppLine;
    ppLine68: TppLine;
    ppLine69: TppLine;
    ppLine70: TppLine;
    ppLine71: TppLine;
    ppLine72: TppLine;
    ppLine73: TppLine;
    ppLine74: TppLine;
    ppLine75: TppLine;
    ppLine76: TppLine;
    ppLine77: TppLine;
    ppSummaryBand6: TppSummaryBand;
    ppShape25: TppShape;
    ppLabel55: TppLabel;
    ppDBCalc69: TppDBCalc;
    ppDBCalc70: TppDBCalc;
    ppDBCalc71: TppDBCalc;
    ppDBCalc72: TppDBCalc;
    ppDBCalc73: TppDBCalc;
    ppGroup10: TppGroup;
    ppGroupHeaderBand10: TppGroupHeaderBand;
    ppShape26: TppShape;
    ppLabel56: TppLabel;
    ppDBText90: TppDBText;
    ppGroupFooterBand10: TppGroupFooterBand;
    ppShape27: TppShape;
    ppLabel57: TppLabel;
    ppDBText91: TppDBText;
    ppDBCalc74: TppDBCalc;
    ppDBCalc75: TppDBCalc;
    ppDBCalc76: TppDBCalc;
    ppDBCalc77: TppDBCalc;
    ppDBCalc78: TppDBCalc;
    ppGroup11: TppGroup;
    ppGroupHeaderBand11: TppGroupHeaderBand;
    ppShape28: TppShape;
    ppDBText92: TppDBText;
    ppDBText93: TppDBText;
    ppGroupFooterBand11: TppGroupFooterBand;
    ppShape29: TppShape;
    ppLabel58: TppLabel;
    ppDBText94: TppDBText;
    ppDBCalc79: TppDBCalc;
    ppDBCalc80: TppDBCalc;
    ppDBCalc81: TppDBCalc;
    ppDBCalc82: TppDBCalc;
    ppDBCalc83: TppDBCalc;
    ppGroup12: TppGroup;
    ppGroupHeaderBand12: TppGroupHeaderBand;
    ppLine78: TppLine;
    ppDBText95: TppDBText;
    ppDBText96: TppDBText;
    ppDBText97: TppDBText;
    ppGroupFooterBand12: TppGroupFooterBand;
    ppShape30: TppShape;
    ppLabel59: TppLabel;
    ppDBText98: TppDBText;
    ppDBCalc84: TppDBCalc;
    ppDBCalc85: TppDBCalc;
    ppDBCalc86: TppDBCalc;
    ppDBCalc87: TppDBCalc;
    ppDBCalc88: TppDBCalc;
    ppParameterList1: TppParameterList;
    DBPRESUMEN: TppBDEPipeline;
    ppBDEPPBANCO2: TppReport;
    ppHeaderBand5: TppHeaderBand;
    ppShape17: TppShape;
    ppLabel14: TppLabel;
    ppLabel27: TppLabel;
    ppLabel29: TppLabel;
    ppLabel34: TppLabel;
    ppLabel35: TppLabel;
    ppLabel36: TppLabel;
    ppLabel37: TppLabel;
    ppLabel38: TppLabel;
    ppLabel39: TppLabel;
    ppLabel40: TppLabel;
    ppXtitulo2: TppLabel;
    ppLabel41: TppLabel;
    ppSystemVariable6: TppSystemVariable;
    ppLabel42: TppLabel;
    ppSystemVariable7: TppSystemVariable;
    ppDetailBand5: TppDetailBand;
    ppDBText60: TppDBText;
    ppDBText61: TppDBText;
    ppDBText62: TppDBText;
    ppDBText63: TppDBText;
    ppDBText64: TppDBText;
    ppDBText65: TppDBText;
    ppDBText66: TppDBText;
    ppDBText67: TppDBText;
    ppDBText68: TppDBText;
    ppLine34: TppLine;
    ppLine35: TppLine;
    ppLine36: TppLine;
    ppLine37: TppLine;
    ppLine38: TppLine;
    ppLine39: TppLine;
    ppLine40: TppLine;
    ppLine41: TppLine;
    ppLine42: TppLine;
    ppLine43: TppLine;
    ppSummaryBand4: TppSummaryBand;
    ppShape18: TppShape;
    ppDBCalc53: TppDBCalc;
    ppDBCalc54: TppDBCalc;
    ppDBCalc55: TppDBCalc;
    ppDBCalc56: TppDBCalc;
    ppDBCalc57: TppDBCalc;
    ppLabel43: TppLabel;
    ppLine44: TppLine;
    ppLine45: TppLine;
    ppLine46: TppLine;
    ppLine47: TppLine;
    ppLine48: TppLine;
    ppSubReport1: TppSubReport;
    ppChildReport1: TppChildReport;
    ppTitleBand1: TppTitleBand;
    ppShape19: TppShape;
    ppLabel44: TppLabel;
    ppLabel45: TppLabel;
    ppLabel46: TppLabel;
    ppLabel47: TppLabel;
    ppLine49: TppLine;
    ppLine50: TppLine;
    ppDetailBand6: TppDetailBand;
    ppShape20: TppShape;
    ppDBText69: TppDBText;
    ppDBText70: TppDBText;
    ppDBText71: TppDBText;
    ppLine51: TppLine;
    ppLine52: TppLine;
    ppSummaryBand5: TppSummaryBand;
    ppShape21: TppShape;
    ppDBCalc58: TppDBCalc;
    ppGroup8: TppGroup;
    ppGroupHeaderBand8: TppGroupHeaderBand;
    PPXSUBTITULO2: TppLabel;
    ppDBText72: TppDBText;
    ppGroupFooterBand8: TppGroupFooterBand;
    ppShape22: TppShape;
    ppDBCalc59: TppDBCalc;
    ppDBCalc60: TppDBCalc;
    ppDBCalc61: TppDBCalc;
    ppDBCalc62: TppDBCalc;
    ppDBCalc63: TppDBCalc;
    ppLabel48: TppLabel;
    ppDBText73: TppDBText;
    ppLine53: TppLine;
    ppLine54: TppLine;
    ppLine55: TppLine;
    ppLine56: TppLine;
    ppLine57: TppLine;
    ppGroup9: TppGroup;
    ppGroupHeaderBand9: TppGroupHeaderBand;
    ppShape23: TppShape;
    ppDBText74: TppDBText;
    ppDBText75: TppDBText;
    ppGroupFooterBand9: TppGroupFooterBand;
    ppLine58: TppLine;
    ppLine59: TppLine;
    ppLine60: TppLine;
    ppLine61: TppLine;
    ppLine62: TppLine;
    ppLine63: TppLine;
    ppDBCalc64: TppDBCalc;
    ppDBCalc65: TppDBCalc;
    ppDBCalc66: TppDBCalc;
    ppDBCalc67: TppDBCalc;
    ppDBCalc68: TppDBCalc;
    ppLine64: TppLine;
    ppLine65: TppLine;
    ppLabel49: TppLabel;
    ppDBText76: TppDBText;
    ppParameterList2: TppParameterList;
    prbAvance: TProgressBar;
    ppdb1: TppDBPipeline;
    ppd1: TppDesigner;
    ppr1: TppReport;
    ppParameterList3: TppParameterList;
    ppdb5: TppDBPipeline;
    ppr5: TppReport;
    ppd5: TppDesigner;
    ppParameterList4: TppParameterList;
    Label1: TLabel;
    Panel2: TPanel;
    bbtnTeleCorrige: TBitBtn;
    bbtnTeleIncons: TBitBtn;
    bbtnVerifCtasCCosTel: TBitBtn;
    Panel3: TPanel;
    bbtnContabTeleAhorro: TBitBtn;
    BitBtn1: TBitBtn;
    fcShapeBtn1: TfcShapeBtn;
    fcShapeBtn3: TfcShapeBtn;
    Label2: TLabel;
    Panel4: TPanel;
    Panel5: TPanel;
    bbtnPlanCorrige: TBitBtn;
    bbtnPlanIncons: TBitBtn;
    bbtnVerifCtasCCosPla: TBitBtn;
    BitBtn2: TBitBtn;
    BitBtn6: TBitBtn;
    fcShapeBtn4: TfcShapeBtn;
    fcShapeBtn5: TfcShapeBtn;
    Label3: TLabel;
    Panel6: TPanel;
    bbtnBolDCorrige: TBitBtn;
    bbtnBolDIncons: TBitBtn;
    bbtnVerifCtasCCosBol: TBitBtn;
    Panel7: TPanel;
    BitBtn3: TBitBtn;
    BitBtn7: TBitBtn;
    fcShapeBtn7: TfcShapeBtn;
    fcShapeBtn8: TfcShapeBtn;
    Panel8: TPanel;
    Panel9: TPanel;
    Label4: TLabel;
    bbtnVerifCtasCCosEfe: TBitBtn;
    bbtnEfeTrans: TBitBtn;
    fcShapeBtn9: TfcShapeBtn;
    ppdb6: TppDBPipeline;
    ppd6: TppDesigner;
    ppr6: TppReport;
    ppParameterList5: TppParameterList;
    bbtnTELSustento: TBitBtn;
    BitBtn5: TBitBtn;
    BitBtn8: TBitBtn;
    BitBtn4: TBitBtn;
    fcShapeBtn10: TfcShapeBtn;
    BitBtn9: TBitBtn;
    ppdb10: TppDBPipeline;
    ppr10: TppReport;
    ppd10: TppDesigner;
    ppParameterList6: TppParameterList;
    Label5: TLabel;
    ppHeaderBand10: TppHeaderBand;
    ppDBText132: TppDBText;
    ppSystemVariable19: TppSystemVariable;
    ppSystemVariable20: TppSystemVariable;
    ppSystemVariable21: TppSystemVariable;
    ppLabel91: TppLabel;
    ppLabel99: TppLabel;
    ppLine87: TppLine;
    ppLine88: TppLine;
    ppLabel100: TppLabel;
    ppLabel101: TppLabel;
    ppLabel102: TppLabel;
    ppLabel103: TppLabel;
    ppLabel104: TppLabel;
    ppLabel105: TppLabel;
    ppLabel106: TppLabel;
    ppDetailBand11: TppDetailBand;
    ppDBText111: TppDBText;
    ppDBText125: TppDBText;
    ppDBText126: TppDBText;
    ppDBText127: TppDBText;
    ppDBText128: TppDBText;
    ppDBText129: TppDBText;
    ppDBText130: TppDBText;
    ppDBText131: TppDBText;
    ppSummaryBand7: TppSummaryBand;
    ppLine90: TppLine;
    ppDBCalc100: TppDBCalc;
    ppDBCalc101: TppDBCalc;
    ppDBCalc102: TppDBCalc;
    ppDBCalc103: TppDBCalc;
    ppDBCalc104: TppDBCalc;
    ppLine91: TppLine;
    ppLabel107: TppLabel;
    ppGroup16: TppGroup;
    ppGroupHeaderBand16: TppGroupHeaderBand;
    ppGroupFooterBand16: TppGroupFooterBand;
    ppLine89: TppLine;
    ppDBCalc95: TppDBCalc;
    ppDBCalc96: TppDBCalc;
    ppDBCalc97: TppDBCalc;
    ppDBCalc98: TppDBCalc;
    ppDBCalc99: TppDBCalc;
    ppDBText133: TppDBText;
    ppHeaderBand9: TppHeaderBand;
    ppLabel83: TppLabel;
    ppSystemVariable16: TppSystemVariable;
    ppSystemVariable17: TppSystemVariable;
    ppLabel84: TppLabel;
    ppLabel86: TppLabel;
    ppLine86: TppLine;
    ppSystemVariable18: TppSystemVariable;
    ppLabel87: TppLabel;
    ppLabel88: TppLabel;
    ppLabel89: TppLabel;
    ppLabel90: TppLabel;
    pplPeriodo6: TppLabel;
    ppLabel85: TppLabel;
    ppLabel92: TppLabel;
    ppLabel93: TppLabel;
    ppLabel94: TppLabel;
    ppLabel95: TppLabel;
    ppLabel96: TppLabel;
    ppLabel97: TppLabel;
    ppLabel98: TppLabel;
    ppLabel68: TppLabel;
    ppLine94: TppLine;
    ppDetailBand10: TppDetailBand;
    ppDBText116: TppDBText;
    ppDBText117: TppDBText;
    ppDBText118: TppDBText;
    ppDBText119: TppDBText;
    ppDBText120: TppDBText;
    ppDBText121: TppDBText;
    ppDBText122: TppDBText;
    ppDBText123: TppDBText;
    ppDBText124: TppDBText;
    ppDBText110: TppDBText;
    ppDBText134: TppDBText;
    ppLine92: TppLine;
    ppSummaryBand8: TppSummaryBand;
    ppLine93: TppLine;
    ppDBCalc105: TppDBCalc;
    ppHeaderBand8: TppHeaderBand;
    ppSystemVariable13: TppSystemVariable;
    ppSystemVariable14: TppSystemVariable;
    ppLabel76: TppLabel;
    ppLabel77: TppLabel;
    ppLabel78: TppLabel;
    ppLine84: TppLine;
    ppLine85: TppLine;
    ppSystemVariable15: TppSystemVariable;
    ppLabel79: TppLabel;
    ppLabel80: TppLabel;
    ppLabel81: TppLabel;
    ppLabel82: TppLabel;
    lblPeriodo: TppLabel;
    ppDBText109: TppDBText;
    ppDetailBand9: TppDetailBand;
    ppDBText114: TppDBText;
    ppDBText115: TppDBText;
    ppFooterBand2: TppFooterBand;
    ppHeaderBand7: TppHeaderBand;
    ppDBText99: TppDBText;
    ppSystemVariable10: TppSystemVariable;
    ppSystemVariable11: TppSystemVariable;
    ppSystemVariable12: TppSystemVariable;
    ppLabel60: TppLabel;
    ppLabel61: TppLabel;
    ppLine79: TppLine;
    ppLine80: TppLine;
    ppLabel62: TppLabel;
    ppLabel63: TppLabel;
    ppLabel64: TppLabel;
    ppLabel65: TppLabel;
    ppLabel66: TppLabel;
    ppLabel67: TppLabel;
    ppLabel70: TppLabel;
    ppLabel71: TppLabel;
    ppDetailBand8: TppDetailBand;
    ppDBText100: TppDBText;
    ppDBText101: TppDBText;
    ppDBText102: TppDBText;
    ppDBText103: TppDBText;
    ppDBText104: TppDBText;
    ppDBText105: TppDBText;
    ppDBText106: TppDBText;
    ppDBText107: TppDBText;
    ppDBText108: TppDBText;
    ppGroup13: TppGroup;
    ppGroupHeaderBand13: TppGroupHeaderBand;
    ppGroupFooterBand13: TppGroupFooterBand;
    ppLine81: TppLine;
    ppDBCalc89: TppDBCalc;
    ppDBCalc90: TppDBCalc;
    ppLabel72: TppLabel;
    ppDBText112: TppDBText;
    ppGroup14: TppGroup;
    ppGroupHeaderBand14: TppGroupHeaderBand;
    ppGroupFooterBand14: TppGroupFooterBand;
    ppLine83: TppLine;
    ppDBCalc93: TppDBCalc;
    ppDBCalc94: TppDBCalc;
    ppLabel74: TppLabel;
    ppDBText113: TppDBText;
    ppGroup15: TppGroup;
    ppGroupHeaderBand15: TppGroupHeaderBand;
    ppGroupFooterBand15: TppGroupFooterBand;
    ppLine82: TppLine;
    ppDBCalc91: TppDBCalc;
    ppDBCalc92: TppDBCalc;
    ppLabel73: TppLabel;
    procedure fcShapeBtn2Click(Sender: TObject);
    procedure dbseMesExit(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure fcShapeBtn6Click(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure bbtnContabTeleAhorroClick(Sender: TObject);
    procedure DatosFecha;
    procedure dbseAnoExit(Sender: TObject);
    procedure bbtnVerifCtasCCosTelClick(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn4Click(Sender: TObject);
    procedure BitBtn3Click(Sender: TObject);
    procedure bbtnVerifCtasCCosBolClick(Sender: TObject);
    procedure bbtnVerifCtasCCosPlaClick(Sender: TObject);
    procedure bbtnVerifCtasCCosEfeClick(Sender: TObject);
    procedure bbtnTeleCorrigeClick(Sender: TObject);
    procedure bbtnPlanCorrigeClick(Sender: TObject);
    procedure bbtnBolDCorrigeClick(Sender: TObject);
    procedure bbtnBolDInconsClick(Sender: TObject);
    procedure bbtnTeleInconsClick(Sender: TObject);
    procedure bbtnPlanInconsClick(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure BitBtn6Click(Sender: TObject);
    procedure BitBtn7Click(Sender: TObject);
    procedure bbtnEfeTransClick(Sender: TObject);
    procedure fcShapeBtn3Click(Sender: TObject);
    procedure fcShapeBtn4Click(Sender: TObject);
    procedure fcShapeBtn5Click(Sender: TObject);
    procedure fcShapeBtn8Click(Sender: TObject);
    procedure fcShapeBtn9Click(Sender: TObject);
    procedure TabSheet5Enter(Sender: TObject);
    procedure TabSheet7Enter(Sender: TObject);
    procedure bbtnTELSustentoClick(Sender: TObject);
    procedure fcShapeBtn1Click(Sender: TObject);
    procedure BitBtn5Click(Sender: TObject);
    procedure BitBtn8Click(Sender: TObject);
    procedure fcShapeBtn7Click(Sender: TObject);
    procedure fcShapeBtn10Click(Sender: TObject);
    procedure BitBtn9Click(Sender: TObject);
  private
    { Private declarations }
    xPeriodo : String;
    xCNT300  : String;
    xCNT311  : String;
    xCnt300r : String;
    xCnt311r : String;
    xMesdes  : String;
    bError   : Boolean;
    xWhereBusqueda : String;
    procedure CorrigeUnidadesDePago( cTipo : String );
    procedure FilIncos;
    procedure FilIncos2;
    procedure FilIncos3;
    procedure ImprimeInconsistenciaVerificaCuentaCCosto( cSQL : String );
    procedure ImprimeInconsistenciaPagosCRE310( cSQL : String );
    procedure ParametrosTeleahorro;
    procedure ParametrosPlanilla;
    procedure ParametrosBoleta;
    procedure UpdatePlanilla;

  public
    procedure TransferirContabilidad(cLote,cOrigen,xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r : String);
    procedure ReporteContabilizaCredito( cTabla, cLote,xPeriodo  : String );
    { Public declarations }
  end;

var
  FContabilizacion: TFContabilizacion;
  wCalcUnaCuota : boolean;
  wTipoCont,wTipoCont2,sValCuota, sMontoCuota, sMontoCob, sAmort, sInteres, sFlat, sExceso,xMesAno : String;
  xMontoCuota, xMontoCob, xAmort, xInteres, xFlat, xExceso : double;
  xValCta, xPagFlat,xPagInteres,xPagAmort : double;

  xfecmes,xfecdia,xfectrim,xfecsem,xfecss,xfecaatri,xfecaasem,xfecaass : String;
  xDiaIni, xDiaFin, xMes, xAno : String;
  xTCambio : String;


implementation

uses COBDM1,COB001;

{$R *.DFM}

procedure TFContabilizacion.fcShapeBtn2Click(Sender: TObject);
begin
  Self.Close;
end;

procedure TFContabilizacion.dbseMesExit(Sender: TObject);
begin
   dbseMes.Text := DM1.StrZero(dbseMes.Text,2);
   DatosFecha;
end;

procedure TFContabilizacion.FormKeyPress(Sender: TObject; var Key: Char);
begin

 If key=#13 Then
  begin
    key:=#0;
    perform(CM_DialogKey,VK_TAB,0);
  end;

end;

procedure TFContabilizacion.fcShapeBtn6Click(Sender: TObject);
var
   xSQL, ySQL, xAsoId, xCredId, xCuota : String;
//   sValCuota, sMontoCuota, sMontoCob, sAmort, sInteres, sFlat, sExceso : String;
//   xMontoCuota, xMontoCob, xAmort, xInteres, xFlat, xExceso : double;
//   xValCta, xPagFlat,xPagInteres,xPagAmort : double;
   wDia, wMes, wAno : word;
   xDia, xMes, xAno : String;
begin
   if not wCalcUnaCuota then
   begin
      xAsoId  := DM1.cdsQry2.FieldByName('ASOID').AsString;
      xCredId := DM1.cdsQry2.FieldByName('CREDID').AsString;
      xCuota  := DM1.cdsQry2.FieldByName('CRECUOTA').AsString;
   end
   else
   begin
      xAsoId  := '0000214337';
      xCredId := '052002240001403';
      xCuota  := '26';
   end;

   xSQL := 'select ASOID,CREDID,CRECUOTA, nvl(CREMTO,0) CREMTO, nvl(CREAMORT,0) CREAMORT,'
          +'nvl(CREINTERES,0) CREINTERES,nvl(CREFLAT,0) CREFLAT,nvl(CREMTOEXC,0) CREMTOEXC,nvl(CREMTOCOB,0) CREMTOCOB,'
          +'CREESTID,CREESTADO '
          +'from CRE302 '
          +'where ASOID='+quotedstr(xAsoId)
          +' and CREDID='+quotedstr(xCredId)
          +' and CRECUOTA='+xCuota;
   DM1.cdsQry4.Close;
   DM1.cdsQry4.Filter:='';
   DM1.cdsQry4.Filtered:=False;
   DM1.cdsQry4.IndexFieldNames:='';
   DM1.cdsQry4.DataRequest(xSQL);
   DM1.cdsQry4.Open;
   if DM1.cdsQry4.recordcount>1 then
   begin
      ShowMessage('Alerta, existe mas de una cuota para el Mismo crédito del Asociado!!!!');
      exit;
   end;
   sMontoCuota:= DM1.cdsQry4.FieldByName('CREMTO').AsString;
   sValCuota  := sMontoCuota;
   sAmort     := DM1.cdsQry4.FieldByName('CREAMORT').AsString;
   sInteres   := DM1.cdsQry4.FieldByName('CREINTERES').AsString;
   sFlat      := DM1.cdsQry4.FieldByName('CREFLAT').AsString;
   sExceso    := DM1.cdsQry4.FieldByName('CREMTOEXC').AsString;
   xValCta    := strtofloat(sValCuota);

   xMontoCuota:= strtofloat(sMontoCuota);
   xAmort     := DM1.FRound(strtofloat(sAmort),15,2);
   xInteres   := DM1.FRound(strtofloat(sInteres),15,2);
   xFlat      := DM1.FRound(strtofloat(sFlat),15,2);
   xExceso    := DM1.FRound(strtofloat(sExceso),15,2);

   xValCta:= DM1.cdsQry4.FieldByName('CREAMORT').AsFloat
            +DM1.cdsQry4.FieldByName('CREINTERES').AsFloat
            +DM1.cdsQry4.FieldByName('CREFLAT').AsFloat
            +DM1.cdsQry4.FieldByName('CREMTOEXC').AsFloat;

   xSQL := 'select ASOID,CREDID,CRECUOTA,CREANO,CREMES,CREFPAG,CREMTOCOB,CREAMORT,'
          +'CREINTERES,CREFLAT,CREMTOEXC,NROOPETMP,FREG '
          +'from CRE310 '
          +'where ASOID='+quotedstr(xAsoId)
          +' and CREDID='+quotedstr(xCredId)
          +' and CRECUOTA='+xCuota;
   ySQL := xSQL;
   DM1.cdsDetalle.Close;
   DM1.cdsDetalle.Filter:='';
   DM1.cdsDetalle.Filtered:=False;
   DM1.cdsDetalle.IndexFieldNames:='';
   DM1.cdsDetalle.DataRequest(xSQL);
   DM1.cdsDetalle.Open;
   DM1.cdsDetalle.IndexFieldNames:='FREG';
   DM1.cdsDetalle.First;
   xPagFlat    := 0;
   xPagInteres := 0;
   xPagAmort   := 0;
   while not DM1.cdsDetalle.EOF do
   begin
      xMontoCob := DM1.FRound(DM1.cdsDetalle.FieldByName('CREMTOCOB').AsFloat,15,2);
      DM1.cdsDetalle.Edit;
      DM1.cdsDetalle.FieldByName('CREMTOEXC').AsFloat  := 0;
      DM1.cdsDetalle.FieldByName('CREFLAT').AsFloat    := 0;
      DM1.cdsDetalle.FieldByName('CREINTERES').AsFloat := 0;
      DM1.cdsDetalle.FieldByName('CREAMORT').AsFloat   := 0;
      if xMontoCob>0 then
      begin
         if xPagFlat<xFlat then
         begin
            if (xFlat-xPagFlat)<xMontoCob then
               DM1.cdsDetalle.FieldByName('CREFLAT').AsFloat:=xFlat-xPagFlat
            else
               DM1.cdsDetalle.FieldByName('CREFLAT').AsFloat:=xMontoCob;
            xMontoCob := xMontoCob-DM1.FRound(DM1.cdsDetalle.FieldByName('CREFLAT').AsFloat,15,2);
            xPagFlat := xPagFlat+DM1.cdsDetalle.FieldByName('CREFLAT').AsFloat;
         end;
      end;
      if xMontoCob>0 then
      begin
         decodedate(DM1.cdsDetalle.FieldByName('CREFPAG').AsDateTime,wAno,wMes,wDia);
         xAno := inttostr(wAno);
         xMes := DM1.strzero(inttostr(wMes),2);
         if (xAno+xMes)>=(DM1.cdsDetalle.FieldByName('CREANO').AsString+DM1.cdsDetalle.FieldByName('CREMES').AsString) then
         begin
            if xPagInteres<xInteres then
            begin
               if (xInteres-xPagInteres)<xMontoCob then
                  DM1.cdsDetalle.FieldByName('CREINTERES').AsFloat:=xInteres-xPagInteres
               else
                  DM1.cdsDetalle.FieldByName('CREINTERES').AsFloat:=xMontoCob;
               xMontoCob := xMontoCob-DM1.FRound(DM1.cdsDetalle.FieldByName('CREINTERES').AsFloat,15,2);
               xPagInteres := xPagInteres+DM1.cdsDetalle.FieldByName('CREINTERES').AsFloat;
            end;
         end;
      end;
      if xMontoCob>0 then
      begin
         if xPagAmort<xAmort then
         begin
            if (xAmort-xPagAmort)<xMontoCob then
               DM1.cdsDetalle.FieldByName('CREAMORT').AsFloat:=xAmort-xPagAmort
            else
               DM1.cdsDetalle.FieldByName('CREAMORT').AsFloat:=xMontoCob;
            xMontoCob := xMontoCob-DM1.FRound(DM1.cdsDetalle.FieldByName('CREAMORT').AsFloat,15,2);
            xPagAmort := xPagAmort+DM1.cdsDetalle.FieldByName('CREAMORT').AsFloat;
         end;
      end;
      if xMontoCob>0 then
      begin
         DM1.cdsDetalle.FieldByName('CREMTOEXC').AsFloat:=xMontoCob;
      end;
//      DM1.cdsDetalle.Post;
      DM1.cdsDetalle.ApplyUpdates(0);
      DM1.cdsDetalle.Next;
   end;
//   DM1.cdsDetalle.DataRequest(ySQL);
//   ShowMessage('ok');
end;

procedure TFContabilizacion.FormActivate(Sender: TObject);
var
   wAno, wMes, wDia : Word;
   xMes : String;
begin
   decodedate(Date,wAno,wMes,wDia);
   wMes:=wMes-1;
   if wMes<=0 then
   begin
      dbseMes.Text := '12';
      dbseAno.Text := inttostr(wAno-1)
   end
   else
   begin
      if wMes<10 then
         dbseMes.Text := '0'+inttostr(wMes)
      else
         dbseMes.Text := inttostr(wMes)
   end;

   DatosFecha;

   xCNT300  := 'CNT300COB';
   xCNT311  := 'CNT311COB';
   xCnt300r := 'CNT300VHN';
   xCnt311r := 'CNT311VHN';
   xCnt300r := 'CNT300';
   xCnt311r := 'CNT311';

end;

procedure TFContabilizacion.bbtnContabTeleAhorroClick(Sender: TObject);
var
   xCia, xSQL, xCNTComprob  : String;
   xNumComp : Integer;
begin
   try
   ParametrosTeleahorro;
   Screen.Cursor:=crHourGlass;
   wTipoCont := 'TE';
   wTipoCont2:= 'TEL';
// Borra Cabecera
   xSQL := 'delete from CNT300COB '
          +'where TDIARID=''32'''
          +' and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE ='+quotedstr( wTipoCont2 );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Borra Movimientos
   xSQL := 'delete from CNT311COB '
          +'where TDIARID=''32'''
          +' and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE ='+quotedstr( wTipoCont2 );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

//   xWhereBusqueda:= ' A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//                  +' and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')';
   //NUEVA BUSQUEDA PARA CONTABILIDAD

//   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
//                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';

// Compañía Principal ('02')
// Total Cobrado
   xSQL := 'Insert into CNT311COB (CIAID, TDIARID, CNTCOMPROB, CNTANO, CNTANOMM, CUENTAID, '
          +'                                 CCOSID,CNTLOTE, CNTGLOSA, CNTDEBEMN, CNTHABEMN ) '
// MONTO COBRADO (DEBE)
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTACOBD,'
          +'null CCOSID, A.UPROID LOTE,'
          +quotedstr('COBRADO: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'sum(NVL(A.CREMTOCOB,0)) DEBE,0.00 HABER '
          +'from CRE310 A, CRE110 B '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'group by A.UPROID,B.CTACOBD '
// Amortizaciones
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, A.UPROID LOTE, '
          +quotedstr('AMORT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREAMORT,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,A.UPROID '
//          +'having B.CIAID is null '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID,A.UPROID LOTE, '
          +quotedstr('EXCESOS: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,A.UPROID '
//          +'having B.CIAID is null '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Intereses
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAINT,'
          +'null CCOSID, A.UPROID LOTE,'
          +quotedstr('INTERES: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREINTERES,0)) HABER '
          +'from CRE310 A,CRE110 B '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'group by B.CIAID,A.UPROID,B.CTAINT '
       //   +'having B.CIAID is null '
// Flat
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAFLAT,'
          +'null CCOSID, A.UPROID LOTE,'
          +quotedstr('FLAT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREFLAT,0)) HABER '
          +'from CRE310 A,CRE110 B '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'group by B.CIAID,A.UPROID,B.CTAFLAT '
       //   +'having B.CIAID is null '
// Otras Compañías (166xxxxx)
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.FILIAL,'
          +'null CCOSID, A.UPROID LOTE,'
          +quotedstr('OTRAS CIAS: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREAMORT,0))+sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A,CRE110 B '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'group by B.CIAID,A.UPROID,FILIAL '
//          +'having B.CIAID is null '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
//////////////////////////////////////////////////////////////////////////////////////////////////////
// ASIENTOS DE LAS OTRAS COMPAÑÍAS
//////////////////////////////////////////////////////////////////////////////////////////////////////
// Monto Cobrado
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAH,'
          +'null CCOSID, A.UPROID LOTE,'
          +quotedstr('COBRADO: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'sum(NVL(A.CREAMORT,0))+sum(nvl(A.CREMTOEXC,0)) DEBE, 0.00 HABER '
          +'from CRE310 A,CRE110 B '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'group by B.CIAID,A.UPROID,CUENTAH '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Amortización
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, A.UPROID LOTE,'
          +quotedstr('AMORT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREAMORT,0))+sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C '
          +'where '+xWhereBusqueda
//          +'  A.FOPERACTMP >= TO_DATE('+quotedstr(xDiaIni)+')'
//          +'  and A.FOPERACTMP <= TO_DATE('+quotedstr(xDiaFin)+')'
          +'  and A.CREESTID<>''13'' and A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,A.UPROID '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// generando otros datos
   xSQL := 'update CNT311COB '
          +'set DOCID='+quotedstr('20')+',CNTSERIE='+quotedstr('000')
          +',CNTNODOC='+quotedstr('TELE-'+dbseAno.text+dbseMes.text)
          +',CNTTCAMBIO='+xTCambio
          +',CNTDH = case when NVL(CNTDEBEMN,0)>0 then ''D'' else ''H'' end'
          +',CNTMTOORI=case when NVL(CNTDEBEMN,0)>0 then NVL(CNTDEBEMN,0) else NVL(CNTHABEMN,0) end'
          +',CNTMTOLOC=case when NVL(CNTDEBEMN,0)>0 then NVL(CNTDEBEMN,0) else NVL(CNTHABEMN,0) end'
          +',CNTMTOEXT=case when NVL(CNTDEBEMN,0)>0 then round(NVL(CNTDEBEMN,0)/'+xTCambio+',2) else round(NVL(CNTHABEMN,0)/'+xTCambio+') end'
          +',CNTFEMIS='+quotedstr(xDiaFin)+',CNTFVCMTO='+quotedstr(xDiaFin)
          +',CNTFCOMP='+quotedstr(xDiaFin)+',CNTESTADO='+quotedstr('I')
          +',CNTCUADRE='+quotedstr('N')
          +',CNTUSER='+quotedstr(dm1.wUsuario)
          +',CNTFREG=SYSDATE'
          +',CNTHREG=SYSDATE'
          +',CNTMM='+quotedstr(xfecmes)
          +',CNTDD='+quotedstr(xfecdia)
          +',CNTTRI='+quotedstr(xfectrim)
          +',CNTSEM='+quotedstr(xfecsem)
          +',CNTSS='+quotedstr(xfecss)
          +',CNTAATRI='+quotedstr(xfecaatri)
          +',CNTAASEM='+quotedstr(xfecaasem)
          +',CNTAASS='+quotedstr(xfecaass)
          +',TMONID='+quotedstr('N')
          +',TDIARDES='+quotedstr('TRANSF. DE COBRANZAS')
          +',DOCDES='+quotedstr('Bol.Depo')
          +',CNTDEBEME=round(NVL(CNTDEBEMN,0)/'+xTCambio+',2)'
          +',CNTHABEME=round(NVL(CNTHABEMN,0)/'+xTCambio+',2)'
          +',CNTTS='+quotedstr('OV')
          +',CNTMODDOC='+quotedstr('COB')
          +',MODULO='+quotedstr('COB')
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   xSQL:='Delete from CNT311COB '
        +' where TDIARID='+quotedstr(wTipoCont)
        +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
        +'   and CNTMTOORI=0 AND CNTMTOLOC=0 AND CNTMTOEXT=0';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   xSQL := 'update CNT311COB A '
//          +'set A.CNTGLOSA=(select trim(B.UPROABR)||'' (''||substr(A.CNTGLOSA,1,4)||'')'' '
          +'set A.CNTGLOSA=(select trim(B.UPROABR) '
          +'                 from APO102 B '
          +'                 where B.UPROID=A.CNTLOTE) '
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   xSQL := 'update CNT311COB '
          +'set CNTGLOSA=CNTGLOSA||'+'-'+quotedstr(dbseAno.text+dbseMes.text)
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);


// Actualizacion de Numero de Comprobante
   xSQL := 'select CIAID,CNTLOTE from CNT311COB '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +' group by CIAID,CNTLOTE ';
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTLOTE';
   DM1.cdsQry3.First;
   while not DM1.cdsQry3.EOF do
   begin
      xCia := DM1.cdsQry3.FieldByName('CIAID').AsString;
      if xCia='02' then
         xNumComp := 10000
      else
         xNumComp := 10000;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CIAID').AsString=xCia) do
      begin
         xCntComprob := DM1.strzero(inttostr(xNumComp),10);
         xSQL := 'update CNT311COB set CNTCOMPROB='+quotedstr(xCntComprob)
                +' where CIAID='+quotedstr(DM1.cdsQry3.FieldByName('CIAID').AsString)
                +'   and TDIARID='+quotedstr(wTipoCont)
                +'   and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
                +'   and CNTLOTE='+quotedstr(DM1.cdsQry3.FieldByName('CNTLOTE').AsString);
         DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
         DM1.cdsQry3.Next;
         xNumComp:=xNumComp+1;
      end;
   end;

// Actualiza Lote como identificador de TeleAhorro
   xSQL := 'update CNT311COB '
          +'set CNTLOTE='+quotedstr(wTipoCont2)
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Actualiza Comprobante
   xSQL := 'insert into CNT300COB ( CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CNTLOTE, '
                                  +'CNTGLOSA, CNTTCAMBIO, CNTFCOMP, CNTESTADO, CNTCUADRE, '
                                  +'CNTUSER, CNTFREG, CNTHREG, CNTANO, CNTMM, CNTDD, CNTTRI, '
                                  +'CNTSEM, CNTSS, CNTAATRI, CNTAASEM, CNTAASS, TMONID, FLAGVAR, '
                                  +'TDIARDES, CNTDEBEMN, CNTDEBEME, CNTHABEMN, CNTHABEME, '
                                  +'CNTTS, DOCMOD, MODULO ) '
          +'select A.CIAID, ''32'', A.CNTANOMM, A.CNTCOMPROB,  A.CNTLOTE, '
//          +'select A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB,  A.CNTLOTE, '
                 +'A.CNTGLOSA CNTGLOSA,'+xTCambio+','+'A.CNTFCOMP, ''I'', ''N'', '
                 +' ''GQUISPE'' CNTUSER, MAX( CNTFREG ), MAX( CNTHREG ), A.CNTANO, '
                 +'A.CNTMM, A.CNTDD, A.CNTTRI, '
                 +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS, '
                 +' ''N'' TMONID, null FLAGVAR, A.TDIARDES, '
                 +'SUM(A.CNTDEBEMN), SUM(A.CNTDEBEME), SUM(A.CNTHABEMN), SUM(A.CNTHABEME), '
                 +'MAX( CNTTS ), MAX( CNTMODDOC), MAX( MODULO ) '
          +'from CNT311COB A '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'group by A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB, A.CNTLOTE,A.CNTGLOSA, '
                   +'A.CNTFCOMP, A.CNTANO, A.CNTMM, A.CNTDD, A.CNTTRI, '
                   +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS,  A.TDIARDES ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   xSQL := 'update CNT311COB '
          +'set TDIARID=''32'' '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      Screen.Cursor:=crDefault;
      ShowMessage('Error : al Contabilizar');
      Exit;
   end;

   xSQL:='select CIAID, CNTCOMPROB, CNTDH, CUENTAID, CCOSID, CNTREG, ROWID from CNT311COB '
        +'where TDIARID='+quotedstr('32')
        +'  and CNTLOTE='+quotedstr(wTipoCont2)
        +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
        +' order by CIAID,CNTCOMPROB,CNTDH,CUENTAID,CCOSID ';
   DM1.cdsCEdu.Close;
   DM1.cdsCEdu.Filter:='';
   DM1.cdsCEdu.Filtered:=False;
   DM1.cdsCEdu.IndexFieldNames:='';
   DM1.cdsCEdu.DataRequest(xSQL);
   DM1.cdsCEdu.Open;
   DM1.cdsCEdu.First;
   while not DM1.cdsCEdu.EOF do
     begin
       xCNTComprob := DM1.cdsCEdu.FieldByName('CNTCOMPROB').AsString;
       xNumComp    := 1;
       while (not DM1.cdsCEdu.EOF) and (DM1.cdsCEdu.FieldByName('CNTCOMPROB').AsString=xCNTComprob) do
         begin
           DM1.cdsCEdu.Edit;
           DM1.cdsCEdu.FieldByName('CNTREG').Value  := xNumComp;
           xNumComp := xNumComp+1;
           DM1.cdsCEdu.Next;
        end;
    end;

    DM1.AplicaDatos( DM1.cdsCEdu, 'CEDU' );

   Screen.Cursor:=crDefault;
   ShowMessage('ok');
end;

procedure TFContabilizacion.DatosFecha;
var
   xSQL : String;
begin
   xDiaIni := '01/'+dbseMes.Text+'/'+dbseAno.Text;
   xMes := DM1.strZero(inttostr(strtoint(dbseMes.Text)+1),2);
   if strtoint(xMes)>12 then
      xDiaFin := '31/12/'+dbseAno.Text
   else
   begin
      xDiaFin := datetostr(strtodate('01/'+xMes+'/'+dbseAno.Text)-1);
   end;
   edtFecha.Text := xDiaFin;
   xPeriodo := dbseAno.Text+dbseMes.Text;

   xSQL := 'SELECT * FROM TGE181 WHERE MESIDR='+quotedstr(dbseMes.Text);
   DM1.cdsQry.close;
   DM1.cdsQry.DataRequest(Xsql);
   DM1.cdsQry.open;
   xMesDes:=dm1.cdsQry.FieldByName('MESDESL').AsString;

   xSQL := 'SELECT * FROM TGE114 WHERE TO_CHAR(FECHA,''DD/MM/YYYY'') = '+quotedstr(xDiaFin);
   DM1.cdsQry.close;
   DM1.cdsQry.DataRequest(Xsql);
   DM1.cdsQry.open;
   xfecmes  := dm1.cdsQry.FieldByName('FECMES').AsString;
   xfecdia  := dm1.cdsQry.FieldByName('FECDIA').AsString;
   xfectrim := dm1.cdsQry.FieldByName('FECTRIM').AsString;
   xfecsem  := dm1.cdsQry.FieldByName('FECSEM').AsString;
   xfecss   := dm1.cdsQry.FieldByName('FECSS').AsString;
   xfecaatri:= dm1.cdsQry.FieldByName('FECAATRI').AsString;
   xfecaasem:= dm1.cdsQry.FieldByName('FECAASEM').AsString;
   xfecaass := dm1.cdsQry.FieldByName('FECAASS').AsString;

   xSQL := 'SELECT * FROM TGE107 WHERE TO_CHAR(FECHA,''DD/MM/YYYY'') = '+quotedstr(xDiaFin);
   DM1.cdsQry.close;
   DM1.cdsQry.DataRequest(Xsql);
   DM1.cdsQry.open;
   xTCambio := dm1.cdsQry.fieldbyname('TCAMVBC').AsString;
   if xTCambio = '' then
      ShowMessage('No hay Tipo de cambio para el ' + xdiafin);
end;

procedure TFContabilizacion.dbseAnoExit(Sender: TObject);
begin
   DatosFecha;
end;

procedure TFContabilizacion.bbtnVerifCtasCCosTelClick(Sender: TObject);
var
   xSQL : String;
begin
   bError:=True;

   ParametrosTeleahorro;

// Verifica que esten todos los Centros de Costos
   xSQL:='Select distinct GLOSA, ''Sin Centro de Costo'' OBSERVACION, '
        +   '''INCONSISTENCIA DE TELEAHORRO'' TITULO '
        +'from ( '
        +  'select ''USE=''||A.USEID||'' y UPAGO=''||A.UPAGOID||'' y UPRO=''||A.UPROID||'' / ''||A.ASOAPENOM||'' / ''||A.CREMTOCOB GLOSA, C.CCOSID '
        +  'from CRE310 A, APO101 C '
        +  'where '+xWhereBusqueda
        //+  'where A.FOPERACTMP>='+quotedstr( xDiaIni )+' and A.FOPERACTMP<='+quotedstr( xDiaFin )+' '
        +   ' and C.USEID(+)=A.USEID and C.UPAGOID(+)=A.UPAGOID and C.UPROID(+)=A.UPROID '
        +   ' AND A.CREESTID<>''13'' AND A.CREESTID<>''99'' '
        +') XX '
        +'where CCOSID is null '
        +'order by GLOSA ';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );


// Verifica que los Tipos de Creditos tengan Cuenta Contable
   xSQL:='select distinct GLOSA, OBSERVACION, '
        +   '''INCONSISTENCIA DE TELEAHORRO'' TITULO '
        +'from ( '
        +  'select A.TIPCREID, B.CIAID, B.CUENTAID, B.CUENTAH, CTAINT, CTAFLAT, FILIAL, CTACOBD, '
        +     '''TIPO CREDITO ''||A.TIPCREID||'' ''||B.TIPCREDES GLOSA, ''FALTA CUENTA: ''||'
        +     'CASE WHEN CUENTAID is null THEN ''DEBE, '' ELSE '''' END||'
        +     'CASE WHEN CUENTAH is null  THEN ''HABER, '' ELSE '''' END||'
        +     'CASE WHEN CTAINT is null   THEN ''INTERES, '' ELSE '''' END||'
        +     'CASE WHEN CTAFLAT is null  THEN ''FLAT, '' ELSE '''' END||'
        +     'CASE WHEN CTACOBD is null  THEN ''COBRANZA, '' ELSE '''' END OBSERVACION '
        +  'from CRE310 A, CRE110 B '
        +  'where '+xWhereBusqueda
        //+  'where A.FOPERACTMP>='+quotedstr(xDiaIni)+' and A.FOPERACTMP<='+quotedstr(xDiaFin)+' '
        +   ' and B.TIPCREID(+)=A.TIPCREID '
        + ' ) XX '
        +'where CUENTAID is null or CUENTAH is null or CTAINT is null or CTAFLAT is null or CTACOBD is null';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

   if bError then
      ShowMessage('ok');
end;

procedure TFContabilizacion.BitBtn2Click(Sender: TObject);
var
   xCia, xSQL, xSQL2, xCNTComprob  : String;
   xNumComp : Integer;
begin
   wTipoCont := 'PL';
   wTipoCont2 := 'PLA';
   ParametrosPlanilla;
   Screen.Cursor:=crHourGlass;
// Borra Cabecera
   xSQL := 'delete from CNT300COB '
          +'where TDIARID=''32'''
          +' and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE ='+quotedstr( wTipoCont2 );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Borra Movimientos
   xSQL := 'delete from CNT311COB '
          +'where TDIARID=''32'''
          +' and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE ='+quotedstr( wTipoCont2 );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Compañía Principal ('02')
// Total Cobrado
   xSQL := 'Insert into CNT311COB (CIAID, TDIARID, CNTCOMPROB, CNTANO, CNTANOMM, CUENTAID, CNTFEMIS, CNTFVCMTO,'
          +'                       CCOSID,CNTLOTE, CNTSERIE, CNTNODOC,CNTGLOSA, CNTDEBEMN, CNTHABEMN ) '

// MONTO COBRADO (DEBE)
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTACOBD, A.FOPERAC, A.FOPERAC, '
          +'null CCOSID, A.UPROID LOTE, ''COBR'' CNTSERIE, A.NROOPE,'
          +quotedstr('COBRADO: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'sum(A.CREMTOCOB) DEBE,0.00 HABER '
          +'from CRE310 A, CRE110 B '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and nvl(A.CREMTOCOB,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CTACOBD,A.FOPERAC,A.FOPERAC '               //RMZ
         //  +'  and F.RCOBID(+)=A.RCOBID '                                          //RMZ
         //  +'group by A.UPROID,A.NROOPE,B.CTACOBD, F.RCOBFOPE, F.RCOBFOPE '        //RMZ
//          +'        ,A.UPROID||''  ''||D.RCOBANO||''-''||D.RCOBMES '

// Amortizaciones
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID, A.FOPERAC,A.FOPERAC,'
          +'C.CCOSID,A.UPROID LOTE, ''AMOR'' CNTSERIE, A.NROOPE,'
          +quotedstr('AMORT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT) HABER '
          +'from CRE310 A, CRE110 B, APO101 C '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and nvl(A.CREAMORT,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CUENTAID,B.CIAID,C.CCOSID,A.FOPERAC,A.FOPERAC '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID, A.FOPERAC, A.FOPERAC,'
          +'C.CCOSID,A.UPROID LOTE, ''EXCE'' CNTSERIE, A.NROOPE,'
          +quotedstr('EXCESOS: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C  '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and nvl(A.CREMTOEXC,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CUENTAID,B.CIAID,C.CCOSID, A.FOPERAC, A.FOPERAC '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Intereses
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAINT, A.FOPERAC, A.FOPERAC,'
          +'null CCOSID, A.UPROID LOTE, ''INTE'' CNTSERIE, A.NROOPE,'
          +quotedstr('INTERES: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(A.CREINTERES) HABER '
          +'from CRE310 A, CRE110 B '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and nvl(A.CREINTERES,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CTAINT,B.CIAID, A.FOPERAC, A.FOPERAC '
// Flat
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAFLAT, A.FOPERAC, A.FOPERAC,'
          +'null CCOSID, A.UPROID LOTE, ''FLAT'' CNTSERIE, A.NROOPE,'
          +quotedstr('FLAT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(A.CREFLAT) HABER '
          +'from CRE310 A, CRE110 B '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and nvl(A.CREFLAT,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CTAFLAT,B.CIAID, A.FOPERAC, A.FOPERAC '
// Otras Compañías (166xxxxx)
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.FILIAL, A.FOPERAC, A.FOPERAC,'
          +'null CCOSID, A.UPROID LOTE, ''OTRA'' CNTSERIE, A.NROOPE,'
          +quotedstr('OTRAS CIAS: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 a, CRE110 B  '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'' '
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
         +'group by A.UPROID,A.NROOPE,B.FILIAL,B.CIAID, A.FOPERAC, A.FOPERAC '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';
//////////////////////////////////////////////////////////////////////////////////////////////////////
// ASIENTOS DE LAS OTRAS COMPAÑÍAS
//////////////////////////////////////////////////////////////////////////////////////////////////////
// Monto Cobrado
      xSQL2:=''
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAH, A.FOPERAC, A.FOPERAC,'
          +'null CCOSID, A.UPROID LOTE, ''COBR'' CNTSERIE, A.NROOPE,'
          +quotedstr('COBRADO: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) DEBE, 0.00 HABER '
          +'from CRE310 A,CRE110 B  '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'group by A.UPROID,A.NROOPE,B.CUENTAH,B.CIAID, A.FOPERAC, A.FOPERAC '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Amortización
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
         +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID, A.FOPERAC, A.FOPERAC,'
          +'C.CCOSID, A.UPROID LOTE, ''AMOR'' CNTSERIE, A.NROOPE,'
          +quotedstr('AMORT: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT) HABER '
          +'from CRE310 A, CRE110 B, APO101 C  '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and nvl(A.CREAMORT,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CUENTAID,B.CIAID,C.CCOSID, A.FOPERAC, A.FOPERAC '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Excesos
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID, A.FOPERAC, A.FOPERAC,'
          +'C.CCOSID, A.UPROID LOTE, ''EXCE'' CNTSERIE, A.NROOPE,'
          +quotedstr('EXCESOS: U.Proc: ')+'||A.UPROID||''  ''||'+quotedstr(dbseAno.text+dbseMes.text)+'  GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C  '
          +'where '+xWhereBusqueda
          //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
          //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and A.CREESTID<>''13'' AND A.CREESTID<>''04'' AND A.CREESTID<>''99'''
          +'  and B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and nvl(A.CREMTOEXC,0)>0 '
          +'group by A.UPROID,A.NROOPE,B.CUENTAID,B.CIAID,C.CCOSID, A.FOPERAC, A.FOPERAC '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL+xSQL2);

// generando otros datos
   xSql := 'update CNT311COB '
          +'set DOCID='+quotedstr('20')// +',CNTSERIE='+quotedstr('000')
          +',CNTTCAMBIO='+xTCambio
          +',CNTDH = case when CNTDEBEMN>0 then ''D'' else ''H'' end'
          +',CNTMTOORI=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOLOC=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOEXT=case when CNTDEBEMN>0 then round(CNTDEBEMN/'+xTCambio+',2) else round(CNTHABEMN/'+xTCambio+') end'
          +',CNTFCOMP='+quotedstr(xDiaFin)+',CNTESTADO='+quotedstr('I')
          +',CNTCUADRE='+quotedstr('N')
          +',CNTUSER='+quotedstr(dm1.wUsuario)
          +',CNTFREG=TO_DATE(SYSDATE)'
          +',CNTHREG=SYSDATE'
          +',CNTMM='+quotedstr(xfecmes)
          +',CNTDD='+quotedstr(xfecdia)
          +',CNTTRI='+quotedstr(xfectrim)
          +',CNTSEM='+quotedstr(xfecsem)
          +',CNTSS='+quotedstr(xfecss)
          +',CNTAATRI='+quotedstr(xfecaatri)
          +',CNTAASEM='+quotedstr(xfecaasem)
          +',CNTAASS='+quotedstr(xfecaass)
          +',TMONID='+quotedstr('N')
          +',TDIARDES='+quotedstr('COBRANZA X PLANILLA')
          +',DOCDES='+quotedstr('Cob.Plan')
          +',CNTDEBEME=round(CNTDEBEMN/'+xTCambio+',2)'
          +',CNTHABEME=round(CNTHABEMN/'+xTCambio+',2)'
          +',CNTTS='+quotedstr('OV')
          +',CNTMODDOC='+quotedstr('COB')
          +',MODULO='+quotedstr('COB')
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   xSQL := 'update CNT311COB A '
          +'set A.CNTGLOSA=(select B.UPROABR from APO102 B '
          +'                where B.UPROID=A.CNTLOTE) '
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   xSQL := 'update CNT311COB '
          +'set CNTGLOSA=CNTGLOSA||'+'-'+quotedstr(dbseAno.text+dbseMes.text)
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Actualizacion de Numero de Comprobante
   xSQL := 'select CIAID,CNTLOTE from CNT311COB '
          +' where TDIARID='+quotedstr(wTipoCont)+' and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +' group by CIAID,CNTLOTE ';
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTLOTE';
   DM1.cdsQry3.First;
   while not DM1.cdsQry3.EOF do
   begin
      xCia := DM1.cdsQry3.FieldByName('CIAID').AsString;
      if xCia='02' then
         xNumComp := 20000
      else
         xNumComp := 20000;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CIAID').AsString=xCia) do
      begin
         xCntComprob := DM1.strzero(inttostr(xNumComp),10);
         xSQL := 'update CNT311COB set CNTCOMPROB='+quotedstr(xCntComprob)
                +' where CIAID='+quotedstr(DM1.cdsQry3.FieldByName('CIAID').AsString)
                +'   and TDIARID='+quotedstr(wTipoCont)
                +'   and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
                +'   and CNTLOTE='+quotedstr(DM1.cdsQry3.FieldByName('CNTLOTE').AsString);
         DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
         DM1.cdsQry3.Next;
         xNumComp:=xNumComp+1;
      end;
   end;

// Actualiza Lote como identificador de Planilla
   xSQL := 'update CNT311COB '
          +'set CNTLOTE='+quotedstr(wTipoCont2)+','
          +'    CNTFCOMP=TO_DATE(CNTFCOMP,''DD/MM/YYYY'') '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Numeracion de Item por cada Comprobante Generado
   xSQL := 'update CNT311COB '
          +'set CNTREG=null '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   try
      DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      ShowMessage('No se pudo limpiar el valor de los Items');
   end;
   xSQL := 'select * '
          +'from CNT311COB '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTCOMPROB;CNTDH;CUENTAID;CCOSID';
   DM1.cdsQry3.First;
   while not DM1.cdsQry3.EOF do
   begin
      xCNTComprob := DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString;
      xNumComp := 1;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString=xCNTComprob) do
      begin
         DM1.cdsQry3.Edit;
         DM1.cdsQry3.FieldByName('CNTREG').AsInteger := xNumComp;
         cdsPost(DM1.cdsQry3);
         xNumComp := xNumComp+1;
         DM1.cdsQry3.Next;
      end;
   end;
   if DM1.cdsQry3.ApplyUpdates(0)>0 then
   begin
      ShowMessage('Nro. de Items no actualizados');
   end;

   try
   xSQL := 'update CNT311COB '
          +'set TDIARID=''32'' '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      Screen.Cursor:=crDefault;
      ShowMessage('Error : al Contabilizar');
      Exit;
   end;


// Actualiza Comprobante
   xSQL := 'insert into CNT300COB ( CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CNTLOTE, '
                                  +'CNTGLOSA, CNTTCAMBIO, CNTFCOMP, CNTESTADO, CNTCUADRE, '
                                  +'CNTUSER, CNTFREG, CNTHREG, CNTANO, CNTMM, CNTDD, CNTTRI, '
                                  +'CNTSEM, CNTSS, CNTAATRI, CNTAASEM, CNTAASS, TMONID, FLAGVAR, '
                                  +'TDIARDES, CNTDEBEMN, CNTDEBEME, CNTHABEMN, CNTHABEME, '
                                  +'CNTTS, DOCMOD, MODULO ) '
          +'select A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB,  A.CNTLOTE, '
                 +'A.CNTGLOSA CNTGLOSA,'+xTCambio+','+'A.CNTFCOMP, ''I'', ''N'', '
                 +' ''GQUISPE'' CNTUSER, MAX( CNTFREG ), MAX( CNTHREG ), A.CNTANO, '
                 +'A.CNTMM, A.CNTDD, A.CNTTRI, '
                 +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS, '
                 +' ''N'' TMONID, null FLAGVAR, A.TDIARDES, '
                 +'SUM(A.CNTDEBEMN), SUM(A.CNTDEBEME), SUM(A.CNTHABEMN), SUM(A.CNTHABEME), '
                 +'MAX( CNTTS ), MAX( CNTMODDOC), MAX( MODULO ) '
          +'from CNT311COB A '
          +'where TDIARID='+quotedstr('32')
          +'  and CNTLOTE ='+quotedstr( wTipoCont2 )
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'group by A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB, A.CNTLOTE,A.CNTGLOSA, '
                   +'A.CNTFCOMP, A.CNTANO, A.CNTMM, A.CNTDD, A.CNTTRI, '
                   +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS,  A.TDIARDES ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   Screen.Cursor:=crDefault;
   ShowMessage('ok');
end;

procedure TFContabilizacion.BitBtn4Click(Sender: TObject);
var
   xCia, xSQL, xSQL2, xSQL3, xCNTComprob  : String;
   xNumComp : Integer;
begin
   wTipoCont := 'EF';
   wTipoCont2 := 'EFE';
   Screen.Cursor:=crHourGlass;
//BEGIN
// Borra Cabecera
   xSQL := 'delete from CNT300COB '
          +'where CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE like '+quotedstr( wTipoCont2+'%' );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Borra Movimientos
   xSQL := 'delete from CNT311COB '
          +'where CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE like '+quotedstr( wTipoCont2+'%' );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Compañía Principal ('02')
// Total Cobrado

   xSQL := 'Insert into CNT311COB (CIAID, TDIARID, CNTCOMPROB, CNTANO, CNTANOMM, CUENTAID, '
          +'                       CNTFEMIS, CNTFVCMTO, CNTFCOMP,'
          +'                       CCOSID,CNTLOTE,CNTSERIE,CNTNODOC, CNTGLOSA, CNTDEBEMN, CNTHABEMN ) '
// MONTO COBRADO (DEBE)
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',CTAPRINC CTACAJA,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'null CCOSID, ''EFE'' LOTE, ''COBR'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'sum(A.CREMTOCOB) DEBE,0.00 HABER '
          +'from CRE310 A, CAJA321 ZZ, TGE106 F '
          +'where ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and F.CIAID=''02'' and F.TMONID=''N'' and F.BANCOID=''18'' '
          +'  and nvl(A.CREMTOCOB,0)>0 '
          +'group by to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER, F.CTAPRINC '
// Amortizaciones
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'C.CCOSID, ''EFE'' LOTE, ''AMOR'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT) HABER '
          +'from CRE310 A, CRE110 B, APO101 C, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREAMORT,0)>0 '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'C.CCOSID, ''EFE'' LOTE, ''EXCE'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREMTOEXC,0)>0 '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having NVL(B.CIAID,''02'') = ''02'' ';
// Intereses
   xSQL2 := ''
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAINT,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'null CCOSID, ''EFE'' LOTE, ''INTE'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(A.CREINTERES) HABER '
          +'from CRE310 A, CRE110 B, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREINTERES,0)>0 '
          +'group by B.CIAID,B.CTAINT,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
// Flat
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAFLAT,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'null CCOSID, ''EFE'' LOTE, ''FLAT'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(A.CREFLAT) HABER '
          +'from CRE310 A, CRE110 B, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREFLAT,0)>0 '
          +'group by B.CIAID,B.CTAFLAT,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
// Otras Compañías (166xxxxx)
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.FILIAL,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'null CCOSID, ''EFE'' LOTE, ''OTRA'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 a, CRE110 B, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'group by B.CIAID,B.FILIAL,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having nvl(B.CIAID,''02'') <> ''02'' ';
//////////////////////////////////////////////////////////////////////////////////////////////////////
// ASIENTOS DE LAS OTRAS COMPAÑÍAS
//////////////////////////////////////////////////////////////////////////////////////////////////////
// Monto Cobrado
   xSQL3:=''
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAH,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'null CCOSID, ''EFE'' LOTE, ''COBR'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) DEBE, 0.00 HABER '
          +'from CRE310 A,CRE110 B, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'group by B.CIAID,CUENTAH,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Amortización
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'C.CCOSID, ''EFE'' LOTE, ''AMOR'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(A.CREAMORT) HABER '
          +'from CRE310 A, CRE110 B, APO101 C, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREAMORT,0)>0 '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFEMIS, TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFVCMTO,'
          +'TO_DATE(ECFCOMP,''DD/MM/YYYY'') CNTFCOMP, '
          +'C.CCOSID, ''EFE'' LOTE, ''EXCE'' CNTSERIE, ''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD'') CNTNODOC,'
          +'TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER  GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER '
          +'from CRE310 A, CRE110 B, APO101 C, CAJA321 ZZ '
          +'where B.TIPCREID(+) = A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and nvl(A.CREMTOEXC,0)>0 '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,to_date(ECFCOMP,''DD/MM/YYYY''),''C.EFE-''||TO_CHAR(ECFCOMP,''YYYYMMDD''),TO_CHAR(ECFCOMP,''YYYYMMDD'')||'' ''||ECUSER '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL+xSQL2+xSQL3);
//END;
// generando otros datos
   xSql := 'update CNT311COB '
          +'set DOCID='+quotedstr('20')
          +',CNTTCAMBIO='+xTCambio
          +',CNTDH = case when CNTDEBEMN>0 then ''D'' else ''H'' end'
          +',CNTMTOORI=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOLOC=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOEXT=case when CNTDEBEMN>0 then round(CNTDEBEMN/'+xTCambio+',2) else round(CNTHABEMN/'+xTCambio+') end'
          +',CNTFEMIS='+quotedstr(xDiaFin)+',CNTFVCMTO='+quotedstr(xDiaFin)
          +',CNTFCOMP='+quotedstr(xDiaFin)+',CNTESTADO='+quotedstr('I')
          +',CNTCUADRE='+quotedstr('N')
          +',CNTUSER='+quotedstr(dm1.wUsuario)
          +',CNTFREG=SYSDATE'
          +',CNTHREG=SYSDATE'
          +',CNTMM='+quotedstr(xfecmes)
          +',CNTDD='+quotedstr(xfecdia)
          +',CNTTRI='+quotedstr(xfectrim)
          +',CNTSEM='+quotedstr(xfecsem)
          +',CNTSS='+quotedstr(xfecss)
          +',CNTAATRI='+quotedstr(xfecaatri)
          +',CNTAASEM='+quotedstr(xfecaasem)
          +',CNTAASS='+quotedstr(xfecaass)
          +',TMONID='+quotedstr('N')
          +',TDIARDES='+quotedstr('COB.EN EFECTIVO')
          +',DOCDES='+quotedstr('Cob.Efec')
          +',CNTDEBEME=round(CNTDEBEMN/'+xTCambio+',2)'
          +',CNTHABEME=round(CNTHABEMN/'+xTCambio+',2)'
          +',CNTTS='+quotedstr('OV')
          +',CNTMODDOC='+quotedstr('COB')
          +',MODULO='+quotedstr('COB')
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Actualizacion de Numero de Comprobante
   xSQL := 'select CIAID,CNTCOMPROB,CNTGLOSA from CNT311COB '
          +' where TDIARID=''EF'' and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +' group by CIAID,CNTCOMPROB,CNTGLOSA ';
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTCOMPROB;CNTGLOSA';
   DM1.cdsQry3.First;
   while not DM1.cdsQry3.EOF do
   begin
      xCia := DM1.cdsQry3.FieldByName('CIAID').AsString;
      if xCia='02' then
         xNumComp := 40000
      else
         xNumComp := 40000;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CIAID').AsString=xCia) do
      begin
         xCntComprob := DM1.strzero(inttostr(xNumComp),10);
         xSQL := 'update CNT311COB set CNTCOMPROB='+quotedstr(xCntComprob)
                +' where CIAID='+quotedstr(DM1.cdsQry3.FieldByName('CIAID').AsString)
                +'   and TDIARID=''EF'' '
                +'   and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
                +'   and CNTGLOSA='+quotedstr(DM1.cdsQry3.FieldByName('CNTGLOSA').AsString);
         DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
         DM1.cdsQry3.Next;
         xNumComp:=xNumComp+1;
      end;
   end;

// Numeracion de Item por cada Comprobante Generado
   xSQL := 'update CNT311COB '
          +'set CNTREG=null '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   try
      DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      ShowMessage('No se pudo limpiar el valor de los Items');
   end;
   xSQL := 'select * '
          +'from CNT311COB '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTCOMPROB;CNTDH;CUENTAID;CCOSID';
   DM1.cdsQry3.First;
   while not DM1.cdsQry3.EOF do
   begin
      xCNTComprob := DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString;
      xNumComp := 1;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString=xCNTComprob) do
      begin
         DM1.cdsQry3.Edit;
         DM1.cdsQry3.FieldByName('CNTREG').AsInteger := xNumComp;
         cdsPost(DM1.cdsQry3);
         xNumComp := xNumComp+1;
         DM1.cdsQry3.Next;
      end;
   end;
   if DM1.cdsQry3.ApplyUpdates(0)>0 then
   begin
      ShowMessage('Nro. de Items no actualizados');
   end;

   try
   xSQL := 'update CNT311COB '
          +'set TDIARID=''32'' '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      Screen.Cursor:=crDefault;
      ShowMessage('Error : al Contabilizar');
      Exit;
   end;

// Actualiza Comprobante
   xSQL := 'insert into CNT300COB ( CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CNTLOTE, '
                                  +'CNTGLOSA, CNTTCAMBIO, CNTFCOMP, CNTESTADO, CNTCUADRE, '
                                  +'CNTUSER, CNTFREG, CNTHREG, CNTANO, CNTMM, CNTDD, CNTTRI, '
                                  +'CNTSEM, CNTSS, CNTAATRI, CNTAASEM, CNTAASS, TMONID, FLAGVAR, '
                                  +'TDIARDES, CNTDEBEMN, CNTDEBEME, CNTHABEMN, CNTHABEME, '
                                  +'CNTTS, DOCMOD, MODULO ) '
          +'select A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB,  A.CNTLOTE, '
                 +'A.CNTGLOSA CNTGLOSA,'+xTCambio+','+'A.CNTFCOMP, ''I'', ''N'', '
                 +' ''GQUISPE'' CNTUSER, MAX( CNTFREG ), MAX( CNTHREG ), A.CNTANO, '
                 +'A.CNTMM, A.CNTDD, A.CNTTRI, '
                 +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS, '
                 +' ''N'' TMONID, null FLAGVAR, A.TDIARDES, '
                 +'SUM(A.CNTDEBEMN), SUM(A.CNTDEBEME), SUM(A.CNTHABEMN), SUM(A.CNTHABEME), '
                 +'MAX( CNTTS ), MAX( CNTMODDOC), MAX( MODULO ) '
          +'from CNT311COB A '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'group by A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB, A.CNTLOTE,A.CNTGLOSA, '
                   +'A.CNTFCOMP, A.CNTANO, A.CNTMM, A.CNTDD, A.CNTTRI, '
                   +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS,  A.TDIARDES ';
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   Screen.Cursor:=crDefault;
   ShowMessage('ok');
end;

procedure TFContabilizacion.BitBtn3Click(Sender: TObject);
var
   xCia, xSQL, xSQL2, xSQL3, xSQL4, xCNTComprob,xAnoMes  : String;
   xNumComp : Integer;
begin
   wTipoCont := 'BO';
   wTipoCont2 := 'BOL';
   xAnoMes :=dbseAno.Text+dbseMes.Text;

   ParametrosBoleta;
   Screen.Cursor:=crHourGlass;
// Borra Cabecera
   xSQL := 'delete from CNT300COB '
          +'where CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE like '+quotedstr( wTipoCont2+'%' );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

// Borra Movimientos
   xSQL := 'delete from CNT311COB '
          +'where CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text)
          +' and CNTLOTE like '+quotedstr( wTipoCont2+'%' );
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);


// Compañía Principal ('02')
// Total Cobrado
   xSQL := 'Insert into CNT311COB (CIAID, TDIARID, CNTCOMPROB, CNTANO, CNTANOMM, CUENTAID, '
          +'                       CCOSID,CNTLOTE, CNTSERIE, CNTNODOC,CNTGLOSA, CNTDEBEMN, CNTHABEMN,CNTFEMIS ) '

//-----------------------------------------------------------------------------------
//-- SE INSERTA LOS MOVIMIENTOS DE COBRANZAS X BOL.DEPOSITO DEL MES SOBRE CNT311COB
//-----------------------------------------------------------------------------------
// MONTO COBRADO (DEBE)
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',E.CTAPRINC,'
          +'null CCOSID, ''BOL1'' LOTE, ''COBR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'sum(NVL(A.CREMTOCOB,0)) DEBE,0.00 HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'From CRE310 A, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+ xAnoMes +''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOCOB,0)>0'
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by CREDOCPAG, TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30), E.CTAPRINC '
// Amortizaciones
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL1'' LOTE, ''AMOR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREAMORT,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREAMORT,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL1'' LOTE, ''EXCE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(NVL(A.CREMTOEXC,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOEXC,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Intereses
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAINT,'
          +'null CCOSID, ''BOL1'' LOTE, ''INTE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREINTERES,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREINTERES,0)>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CTAINT,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
// Flat
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAFLAT,'
          +'null CCOSID, ''BOL1'' LOTE, ''FLAT'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREFLAT,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREFLAT,0)>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CTAFLAT,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
// Otras Compañías (166xxxxx)
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.FILIAL,'
          +'null CCOSID, ''BOL1'' LOTE, ''FILI'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREAMORT,0))+sum(nvl(A.CREMTOEXC,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 a, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.FILIAL,B.CIAID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';

//////////////////////////////////////////////////////////////////////////////////////////////////////
// ASIENTOS DE LAS OTRAS COMPAÑÍAS
//////////////////////////////////////////////////////////////////////////////////////////////////////
// Monto Cobrado
      xSQL2:=''
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAH,'
          +'null CCOSID, ''BOL1'' LOTE, ''COBR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'sum(nvl(A.CREAMORT,0))+sum(nvl(A.CREMTOEXC,0)) DEBE, 0.00 HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A,CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=A.CIAID '
          +'group by B.CIAID,CUENTAH,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Amortización
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL1'' LOTE, ''AMOR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREAMORT,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREAMORT,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=A.CIAID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Excesos
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL1'' LOTE, ''EXCE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA, '
          +'0.00 DEBE, sum(nvl(A.CREMTOEXC,0)) HABER,'
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')='+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOEXC,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=A.CIAID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';


//-----------------------------------------------------------------------------------
//-- SE INSERTA LOS MOVIMIENTOS DE COBRANZAS X BOL.DEPOSITO DE MESES ANTERIORES SOBRE CNT311COB
//-----------------------------------------------------------------------------------
// MONTO COBRADO (DEBE)
      xSQL3:=''
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',E.CTAOPEXLIQ,'
          +'null CCOSID, ''BOL2'' LOTE, ''COBR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'sum(A.CREMTOCOB) DEBE,0.00 HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOCOB,0)>0'
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by CREDOCPAG, TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30), E.CTAOPEXLIQ '
// Amortizaciones
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL2'' LOTE, ''AMOR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREAMORT) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
           +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREAMORT,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Excesos
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL2'' LOTE, ''EXCE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREMTOEXC) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOEXC,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') = ''02'' '
// Intereses
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAINT,'
          +'null CCOSID, ''BOL2'' LOTE, ''INTE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREINTERES) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREINTERES,0)>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CTAINT,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
// Flat
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CTAFLAT,'
          +'null CCOSID, ''BOL2'' LOTE, ''FLAT'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREFLAT) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREFLAT,0)>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.CIAID,B.CTAFLAT,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
// Otras Compañías (166xxxxx)
          +'union all '
          +'select '+quotedstr('02')+','+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.FILIAL,'
          +'null CCOSID, ''BOL2'' LOTE, ''FILI'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 a, CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=''02'' '
          +'group by B.FILIAL,B.CIAID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';
//////////////////////////////////////////////////////////////////////////////////////////////////////
// ASIENTOS DE LAS OTRAS COMPAÑÍAS
//////////////////////////////////////////////////////////////////////////////////////////////////////
// Monto Cobrado
      xSQL4:=''
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAH,'
          +'null CCOSID, ''BOL2'' LOTE, ''COBR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'sum(A.CREAMORT)+sum(nvl(A.CREMTOEXC,0)) DEBE, 0.00 HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A,CRE110 B, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and (nvl(A.CREAMORT,0)+nvl(A.CREMTOEXC,0))>0 '
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=B.CIAID '
          +'group by B.CIAID,CUENTAH,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Amortización
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL2'' LOTE, ''AMOR'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREAMORT) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREAMORT,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=B.CIAID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' '
// Excesos
          +'union all '
          +'select B.CIAID,'+quotedstr(wTipoCont)+','
          +quotedstr('0000000001')+','+quotedstr(dbseAno.text)+','
          +quotedstr(dbseAno.text+dbseMes.text)+',B.CUENTAID,'
          +'C.CCOSID, ''BOL2'' LOTE, ''EXCE'' CNTSERIE, A.CREDOCPAG,'
          +'TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) GLOSA,'
          +'0.00 DEBE, sum(A.CREMTOEXC) HABER, '
          +'MAX(A.FOPERAC) FOPERAC '
          +'from CRE310 A, CRE110 B, APO101 C, TGE106 E '
          +'where A.FORPAGID=''03'' '
          +'  and CNTANOMM='''+xAnoMes+''''
          +'  and TO_CHAR(FOPERAC,''YYYYMM'')<'+quotedstr(dbseAno.text+dbseMes.text)
          +'  and CREESTID<>''13'''
          +'  and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREMTOEXC,0)>0'
          +'  and B.TIPCREID(+)=A.TIPCREID '
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and E.BANCOID=A.BANCOID'
          +'  and E.CCBCOID=A.CCBCOID'
          +'  and E.CIAID=B.CIAID '
          +'group by B.CIAID,B.CUENTAID,C.CCOSID,CREDOCPAG,TO_CHAR(A.FREG,''YYYYMMDD'')||''-''||SUBSTR(A.ASOAPENOM,1,30) '
          +'having NVL(B.CIAID,''02'') <> ''02'' ';

    DM1.DCOM1.AppServer.EjecutaSQL(xSQL+xSQL2+xSQL3+xSQL4);


    //DM1.DCOM1.AppServer.EjecutaSQL(xSQL+xSQL2);

// generando otros datos
   xSql := 'update CNT311COB '
          +'set DOCID='+quotedstr('20')// +',CNTSERIE='+quotedstr('000')
          +',CNTTCAMBIO='+xTCambio
          +',CNTDH = case when CNTDEBEMN>0 then ''D'' else ''H'' end'
          +',CNTMTOORI=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOLOC=case when CNTDEBEMN>0 then CNTDEBEMN else CNTHABEMN end'
          +',CNTMTOEXT=case when CNTDEBEMN>0 then round(CNTDEBEMN/'+xTCambio+',2) else round(CNTHABEMN/'+xTCambio+') end'
          +',CNTFVCMTO='+quotedstr(xDiaFin)
          +',CNTFCOMP='+quotedstr(xDiaFin)+',CNTESTADO='+quotedstr('I')
          +',CNTCUADRE='+quotedstr('N')
          +',CNTUSER='+quotedstr(dm1.wUsuario)
          +',CNTFREG=SYSDATE'
          +',CNTHREG=SYSDATE'
          +',CNTMM='+quotedstr(xfecmes)
          +',CNTDD='+quotedstr(xfecdia)
          +',CNTTRI='+quotedstr(xfectrim)
          +',CNTSEM='+quotedstr(xfecsem)
          +',CNTSS='+quotedstr(xfecss)
          +',CNTAATRI='+quotedstr(xfecaatri)
          +',CNTAASEM='+quotedstr(xfecaasem)
          +',CNTAASS='+quotedstr(xfecaass)
          +',TMONID='+quotedstr('N')
          +',TDIARDES='+quotedstr('COBRANZA X BOL.DEPO')
          +',DOCDES='+quotedstr('Cob.Bole')
          +',CNTDEBEME=round(CNTDEBEMN/'+xTCambio+',2)'
          +',CNTHABEME=round(CNTHABEMN/'+xTCambio+',2)'
          +',CNTTS='+quotedstr('OV')
          +',CNTMODDOC='+quotedstr('COB')
          +',MODULO='+quotedstr('COB')
          +' where TDIARID='+quotedstr(wTipoCont)
          +'   and CNTANOMM ='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);


// Actualizacion de Numero de Comprobante
   xSQL := 'select CIAID,CNTLOTE,substr(CNTGLOSA,1,8) CNTGLOSA '
          +'from CNT311COB '
          +' where TDIARID='+quotedstr(wTipoCont)+' and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +' group by CIAID,CNTLOTE,substr(CNTGLOSA,1,8) ';

   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTLOTE;CNTGLOSA';
   DM1.cdsQry3.First;

   while not DM1.cdsQry3.EOF do
   begin
      xCia := DM1.cdsQry3.FieldByName('CIAID').AsString;
      if xCia='02' then
         xNumComp := 30000
      else
         xNumComp := 30000;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CIAID').AsString=xCia) do
      begin
         xCntComprob := DM1.strzero(inttostr(xNumComp),10);
         xSQL := 'update CNT311COB set CNTCOMPROB='+quotedstr(xCntComprob)
                +' where CIAID='+quotedstr(DM1.cdsQry3.FieldByName('CIAID').AsString)
                +'   and TDIARID='+quotedstr(wTipoCont)
                +'   and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
                +'   and CNTLOTE='+quotedstr(DM1.cdsQry3.FieldByName('CNTLOTE').AsString)
                +'   and substr(CNTGLOSA,1,8)='+quotedstr(DM1.cdsQry3.FieldByName('CNTGLOSA').AsString);
         DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
         DM1.cdsQry3.Next;
         xNumComp:=xNumComp+1;
      end;
   end;


// Numeracion de Item por cada Comprobante Generado
   xSQL := 'update CNT311COB '
          +'set CNTREG=null '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   try
      DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      ShowMessage('No se pudo limpiar el valor de los Items');
   end;
   xSQL := 'select * '
          +'from CNT311COB '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(xSQL);
   DM1.cdsQry3.Open;
   DM1.cdsQry3.IndexFieldNames:='CIAID;CNTCOMPROB;CNTDH;CUENTAID;CCOSID';
   DM1.cdsQry3.First;

   while not DM1.cdsQry3.EOF do
   begin
      xCNTComprob := DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString;
      xNumComp := 1;
      while (not DM1.cdsQry3.EOF) and (DM1.cdsQry3.FieldByName('CNTCOMPROB').AsString=xCNTComprob) do
      begin
         DM1.cdsQry3.Edit;
         DM1.cdsQry3.FieldByName('CNTREG').AsInteger := xNumComp;
         xNumComp := xNumComp+1;
         DM1.cdsQry3.Next;
      end;
   end;
   if DM1.cdsQry3.ApplyUpdates(0)>0 then
      begin
        ShowMessage('Nro. de Items no actualizados');
      end;

   try
   xSQL := 'update CNT311COB '
          +'set TDIARID=''35'' '
          +'where TDIARID='+quotedstr(wTipoCont)
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text);
   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);
   except
      Screen.Cursor:=crDefault;
      ShowMessage('Error : al Contabilizar');
      Exit;
   end;

// Actualiza Comprobante
   xSQL := 'insert into CNT300COB ( CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CNTLOTE, '
                                  +'CNTGLOSA, CNTTCAMBIO, CNTFCOMP, CNTESTADO, CNTCUADRE, '
                                  +'CNTUSER, CNTFREG, CNTHREG, CNTANO, CNTMM, CNTDD, CNTTRI, '
                                  +'CNTSEM, CNTSS, CNTAATRI, CNTAASEM, CNTAASS, TMONID, FLAGVAR, '
                                  +'TDIARDES, CNTDEBEMN, CNTDEBEME, CNTHABEMN, CNTHABEME, '
                                  +'CNTTS, DOCMOD, MODULO ) '
          +'select A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB,  A.CNTLOTE, '
                 +' ''BOLETAS DEPOSITO ''||substr(A.CNTGLOSA,1,8) CNTGLOSA,'+xTCambio+','+'A.CNTFCOMP, ''I'', ''N'', '
                 +' ''GQUISPE'' CNTUSER, MAX( CNTFREG ), MAX( CNTHREG ), A.CNTANO, '
                 +'A.CNTMM, A.CNTDD, A.CNTTRI, '
                 +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS, '
                 +' ''N'' TMONID, null FLAGVAR, A.TDIARDES, '
                 +'SUM(A.CNTDEBEMN), SUM(A.CNTDEBEME), SUM(A.CNTHABEMN), SUM(A.CNTHABEME), '
                 +'MAX( CNTTS ), MAX( CNTMODDOC), MAX( MODULO ) '
          +'from CNT311COB A '
          +'where TDIARID='+quotedstr('35')
          +'  and CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
          +'group by A.CIAID, A.TDIARID, A.CNTANOMM, A.CNTCOMPROB, A.CNTLOTE,''BOLETAS DEPOSITO ''||substr(A.CNTGLOSA,1,8), '
                   +'A.CNTFCOMP, A.CNTANO, A.CNTMM, A.CNTDD, A.CNTTRI, '
                   +'A.CNTSEM, A.CNTSS, A.CNTAATRI, A.CNTAASEM, A.CNTAASS,  A.TDIARDES '
          +'order by A.CIAID,A.CNTCOMPROB ';

   DM1.DCOM1.AppServer.EjecutaSQL(xSQL);

   Screen.Cursor:=crDefault;
   ShowMessage('ok');
end;


procedure TFContabilizacion.bbtnVerifCtasCCosBolClick(Sender: TObject);
var
   xSQL, xGlosa,xAnoMEs: String;
begin
// Verifica que esten todos los Centros de Costos

   ParametrosBoleta;

   bError:=True;
   xAnoMes :=dbseAno.Text+dbseMes.Text;

// Boletas de Depósito
   xSQL := 'select GLOSA, ''Sin Centro de Costo'' OBSERVACION, '
          +'''INCONSISTENCIA DE BOLETAS DE DEPOSITO'' TITULO '
          +'from( '
          +'select ''USE=''||A.USEID||'' y UPAGO=''||A.UPAGOID||'' y UPRO=''||A.UPROID||'' / ''||A.ASOAPENOM||''/ ''||BANCOABR||''/ ''||A.CREMTOCOB  GLOSA, '
          +  'C.CCOSID '
          +'from CRE310 A, APO101 C, TGE105 D '
          +'where '+xWhereBusqueda
          //+'where A.FORPAGID=''03'' '
          //+'  and CNTANOMM='''+xAnoMes+''''
          +'  and CREESTID<>''13'' and CREESTID<>''99'''
          +'  and CREDOCPAG is not null'
          +'  and A.BANCOID is not null'
          +'  and A.CCBCOID is not null'
          +'  and nvl(A.CREAMORT,0)>0'
          +'  and C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and a.bancoid=d.bancoid(+) '
          +') XX '
          +'where CCOSID is null '
          +'order by GLOSA ';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

// Verifica que los Tipos de Creditos tengan Cuenta Contable
   xSQL:='select distinct GLOSA, OBSERVACION, '
        +  '''INCONSISTENCIA DE BOLETAS DE DEPOSITO'' TITULO '
        +'from ( '
        +  'select A.TIPCREID, B.CIAID, B.CUENTAID, B.CUENTAH, CTAINT, CTAFLAT, FILIAL, CTACOBD, '
        +     '''TIPO CREDITO ''||A.TIPCREID||'' ''||B.TIPCREDES GLOSA, ''FALTA CUENTA: ''||'
        +     'CASE WHEN CUENTAID is null THEN ''DEBE, '' ELSE '''' END||'
        +     'CASE WHEN CUENTAH is null  THEN ''HABER, '' ELSE '''' END||'
        +     'CASE WHEN CTAINT is null   THEN ''INTERES, '' ELSE '''' END||'
        +     'CASE WHEN CTAFLAT is null  THEN ''FLAT, '' ELSE '''' END||'
        +     'CASE WHEN CTACOBD is null  THEN ''COBRANZA, '' ELSE '''' END OBSERVACION '
        +  'from CRE310 A, CRE110 B '
        +  'where '+xWhereBusqueda
        //+  'where A.FORPAGID=''03'' '
        //+    'and CNTANOMM='''+xAnoMes+''' '
        +    'and CREESTID<>''13''  and CREESTID<>''99'' '
        +    'and CREDOCPAG is not null '
        +    'and A.BANCOID is not null '
        +    'and A.CCBCOID is not null '
        +    'and nvl(A.CREAMORT,0)>0 '
        +    'and B.TIPCREID(+)=A.TIPCREID '
        +' ) XX '
        +'where CUENTAID is null or CUENTAH is null or CTAINT is null or CTAFLAT is null or CTACOBD is null';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

   xSQL:='select GLOSA, ''Sin Cuenta Contable - Asociado ''||ASOID||'' CR:''||CREDID||'' CT:''||CRECUOTA OBSERVACION, '
        +  '''INCONSISTENCIA DE BOLETAS DE DEPOSITO'' TITULO '
        +'from( '
        +'select ''Banco: ''||A.BANCOID||'' Cuenta Corriente: ''||A.CCBCOID GLOSA, '
        +  'A.ASOID, A.CREDID, A.CRECUOTA, E.CTAPRINC '
        +'from CRE310 A, TGE106 E '
        +'where '+xWhereBusqueda
        //+'where A.FORPAGID=''03'' '
        //+  'and CNTANOMM='''+xAnoMes+''' '
        +  'and CREESTID<>''13'' and CREESTID<>''99'' '
        +  'and CREDOCPAG is not null '
        +  'and A.BANCOID is not null '
        +  'and A.CCBCOID is not null '
        +  'and nvl(A.CREMTOCOB,0)>0 '
        +  'and E.BANCOID(+)=A.BANCOID '
        +  'and E.CCBCOID(+)=A.CCBCOID '
        +  'and E.CIAID(+)=''02'' '
        +' ) XX '
        +'where CTAPRINC is null';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

   if bError then
      ShowMessage('ok');
end;


procedure TFContabilizacion.bbtnVerifCtasCCosPlaClick(Sender: TObject);
var
   xSQL : String;
begin
   bError:=True;

   ParametrosPlanilla;
   UpdatePlanilla;

// Verifica que esten todos los Centros de Costos
   xSQL:='select distinct GLOSA, ''Sin Centro de Costo'' OBSERVACION, '
        +   '''INCONSISTENCIA DE PLANILLAS'' TITULO '
        +'from( '
        +'select ''USE=''||A.USEID||'' y UPAGO=''||A.UPAGOID||'' y UPRO=''||A.UPROID||'' / ''||A.ASOAPENOM||'' / ''||A.CREMTOCOB GLOSA,C.CCOSID '
        +'from CRE310 A, APO101 C '
        +'where '+xWhereBusqueda
        //+'where A.TIPOCONT='+quotedstr(wTipoCont2)
        //+'  and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
        +'  and C.USEID(+)=A.USEID   and C.UPAGOID(+)=A.UPAGOID   and C.UPROID(+)=A.UPROID '
        +'  AND A.CREESTID<>''13'' AND A.CREESTID<>''99'' '
        +') XX '
        +'where CCOSID is null '
        +'order by GLOSA ';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

// Verifica que los Tipos de Creditos tengan Cuenta Contable
   xSQL:='select distinct GLOSA, OBSERVACION, '
        +   '''INCONSISTENCIA DE PLANILLAS'' TITULO '
        +'from ( '
        +  'select A.TIPCREID, B.CIAID, B.CUENTAID, B.CUENTAH, CTAINT, CTAFLAT, FILIAL, CTACOBD, '
        +     '''TIPO CREDITO ''||A.TIPCREID||'' ''||B.TIPCREDES GLOSA, ''FALTA CUENTA: ''||'
        +     'CASE WHEN CUENTAID is null THEN ''DEBE, '' ELSE '''' END||'
        +     'CASE WHEN CUENTAH is null  THEN ''HABER, '' ELSE '''' END||'
        +     'CASE WHEN CTAINT is null   THEN ''INTERES, '' ELSE '''' END||'
        +     'CASE WHEN CTAFLAT is null  THEN ''FLAT, '' ELSE '''' END||'
        +     'CASE WHEN CTACOBD is null  THEN ''COBRANZA, '' ELSE '''' END OBSERVACION '
        +  'from CRE310 A, CRE110 B '
        +  'where '+xWhereBusqueda
        //+  'where A.TIPOCONT='+quotedstr(wTipoCont2)
        //+   ' and A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
        +   ' and B.TIPCREID(+)=A.TIPCREID  AND A.CREESTID<>''13'' AND A.CREESTID<>''99'' '
        +' ) XX '
        +'where CUENTAID is null or CUENTAH is null or CTAINT is null or CTAFLAT is null or CTACOBD is null';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

   if bError then
      ShowMessage('ok');
end;


procedure TFContabilizacion.bbtnVerifCtasCCosEfeClick(Sender: TObject);
var
   xSQL : String;
begin
   bError:=True;

// Verifica que esten todos los Centros de Costos
   xSQL := 'select distinct GLOSA, ''Sin Centro de Costo'' OBSERVACION, '
          +   '''INCONSISTENCIA DE COBRANZAS EN EFECTIVO'' TITULO '
          +' from( '
          +'select ''USE=''||A.USEID||'' y UPAGO=''||A.UPAGOID||'' y UPRO=''||A.UPROID||'' / ''||A.ASOAPENOM||''/ ''||BANCOABR||''/ ''||A.CREMTOCOB GLOSA, C.CCOSID '
          +'from CRE310 A, APO101 C, CAJA321 ZZ, TGE105 D '
          +'where C.USEID(+)=A.USEID '
          +'  and C.UPAGOID(+)=A.UPAGOID '
          +'  and C.UPROID(+)=A.UPROID '
          +'  and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
          +'  and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
          +'  and ZZ.ECESTADO=''C'' '
          +'  and a.bancoid=d.bancoid(+) '
          +') XX '
          +'where CCOSID is null '
          +'order by GLOSA ';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

// Verifica que los Tipos de Creditos tengan Cuenta Contable
   xSQL:='select distinct GLOSA, OBSERVACION, '
        +   '''INCONSISTENCIA DE COBRANZAS EN EFECTIVO'' TITULO '
        +'from ( '
        +  'select A.TIPCREID, B.CIAID, B.CUENTAID, B.CUENTAH, CTAINT, CTAFLAT, FILIAL, CTACOBD, '
        +     '''TIPO CREDITO ''||A.TIPCREID||'' ''||B.TIPCREDES GLOSA, ''FALTA CUENTA: ''||'
        +     'CASE WHEN B.CUENTAID is null THEN ''DEBE, '' ELSE '''' END||'
        +     'CASE WHEN CUENTAH is null  THEN ''HABER, '' ELSE '''' END||'
        +     'CASE WHEN CTAINT is null   THEN ''INTERES, '' ELSE '''' END||'
        +     'CASE WHEN CTAFLAT is null  THEN ''FLAT, '' ELSE '''' END||'
        +     'CASE WHEN CTACOBD is null  THEN ''COBRANZA, '' ELSE '''' END OBSERVACION '
        +  'from CRE310 A, CRE110 B, CAJA321 ZZ '
        +  'where B.TIPCREID(+) = A.TIPCREID '
        +    'and ZZ.ECANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' AND ZZ.CPTOID=''ME0004'' '
        +    'and ZZ.PROV=A.ASOID AND ZZ.ECNODOC=A.NROOPE '
        +    'and ZZ.ECESTADO=''C'' '
        +' ) XX '
        +'where CUENTAID is null or CUENTAH is null or CTAINT is null or CTAFLAT is null or CTACOBD is null';
   ImprimeInconsistenciaVerificaCuentaCCosto( xSQL );

   if bError then
      ShowMessage('ok');
end;

procedure TFContabilizacion.bbtnTeleCorrigeClick(Sender: TObject);
begin
   ParametrosTeleahorro;
   CorrigeUnidadesDePago( 'TELEAHORRO' );

   ShowMessage('Proceso Concluido');
end;

procedure TFContabilizacion.bbtnPlanCorrigeClick(Sender: TObject);
begin
   ParametrosPlanilla;
   UpdatePlanilla;
   CorrigeUnidadesDePago( 'PLANILLA' );

   ShowMessage('Proceso Concluido');
end;

procedure TFContabilizacion.bbtnBolDCorrigeClick(Sender: TObject);
begin
   ParametrosBoleta;
   CorrigeUnidadesDePago( 'BOLETAS' );

   ShowMessage('Proceso Concluido');
end;

procedure TFContabilizacion.CorrigeUnidadesDePago( cTipo : String );
var
   xSql:string;
begin

  Screen.Cursor:=crHourGlass;

  // Primera pasada pones la Useid Uproid y Upagoid del Apo201

  // Filtra del CRE310 Aquellas Uses Uproid Upagoid no estan en APO101

  if cTipo='TELEAHORRO' then
     FilIncos;   //TELEAHORROS;

  if cTipo='BOLETAS' then
     FilIncos2;  //boleta de deposito;

  if cTipo='PLANILLA' then
     FilIncos3;  //Planilla de Regiones

  while not DM1.cdsQry1.Eof do
  begin
     //Filtra del CRE301 La cuota a modificar               ¿
     xSQL := 'SELECT A.* FROM CRE310 A '
           + 'WHERE ASOID='''  +DM1.cdsQry1.FieldByName('ASOID').AsString   +''' '
           +  'and CREDID='''  +DM1.cdsQry1.FieldByName('CREDID').AsString  +''' '
           +  'and CRECUOTA='+DM1.cdsQry1.FieldByName('CRECUOTA').AsString;
     DM1.cdsCambios.Close;
     DM1.cdsCambios.DataRequest(xSQL);
     DM1.cdsCambios.Open;
     if DM1.cdsCambios.RecordCount >= 1 then
       Begin
         while not DM1.cdsCambios.Eof do
           begin
           // Actualiza la USEID, UPROID, UPAGOID de la tabla APO201
              xSql:= 'Select asoid,useid,uproid,upagoid From APO201 Where ASOID='''+DM1.cdsCambios.FieldByName('ASOID').AsString +''' ';
              DM1.cdsQry2.Close;
              DM1.cdsQry2.DataRequest(xSql);
              DM1.cdsQry2.Open;

              If DM1.cdsQry2.RecordCount >=1 then
                begin
                  DM1.cdsCambios.Edit;
                  DM1.cdsCambios.FieldByName('USEID').AsString  := DM1.cdsQry2.FieldByName('USEID').AsString ;
                  DM1.cdsCambios.FieldByName('UPROID').AsString := DM1.cdsQry2.FieldByName('UPROID').AsString ;
                  DM1.cdsCambios.FieldByName('UPAGOID').AsString:= DM1.cdsQry2.FieldByName('UPAGOID').AsString ;
                  DM1.cdsCambios.ApplyUpdates(0);
                end;

            DM1.cdsCambios.Next;
         End
     End;
     DM1.cdsQry1.Next;
  end;


  // Segunda pasada actualiza del APO101 el Upagoid

  //Filtra del CRE310 Aquellas Uses Uproid Upagoid no estan en APO101

  if cTipo='TELEAHORRO' then
     FilIncos;      //TELEAHORROS;

  if cTipo='BOLETAS' then
     FilIncos2;     //Boleta de deposito;

  if cTipo='PLANILLA' then
     FilIncos3;     //Planilla de Regiones

  while not DM1.cdsQry1.Eof do
  begin
     //Filtra del CRE301 La cuota a modificar la unida de pago
     xSql := 'SELECT * FROM CRE310 '
           + 'WHERE ASOID ='''    +DM1.cdsQry1.FieldByName('ASOID').AsString   +''' '
           +  ' and CREDID = '''  +DM1.cdsQry1.FieldByName('CREDID').AsString  +''' '
           +  ' and CRECUOTA = '''+DM1.cdsQry1.FieldByName('CRECUOTA').AsString+''' ' ;
     DM1.cdsCambios.Close;
     DM1.cdsCambios.DataRequest(xSQL);
     DM1.cdsCambios.Open;
     if DM1.cdsCambios.RecordCount >= 1 then
     begin
        while not DM1.cdsCambios.Eof do
        begin
           // Actualiza la Upagoid de la tabla APO101
           xSql:= 'Select * From APO101 Where USEID='''+DM1.cdsCambios.FieldByName('USEID').AsString +
                  ''' and UPROID='''+DM1.cdsCambios.FieldByName('UPROID').AsString +''' ';
           DM1.cdsQry2.Close;
           DM1.cdsQry2.DataRequest(xSql);
           DM1.cdsQry2.Open;

           if DM1.cdsQry2.RecordCount >=1 then
           begin
              DM1.cdsCambios.Edit;
              DM1.cdsCambios.FieldByName('UPAGOID').AsString := DM1.cdsQry2.FieldByName('UPAGOID').AsString ;
              DM1.cdsCambios.ApplyUpdates(0);
           end
           else
             //SI NO LO ENCUENTRA POR UPROID+USEID LO BUSCA POR UPROID+UPAGOID
           begin
              xSql:= 'Select * From APO101 Where UPAGOID='''+DM1.cdsCambios.FieldByName('UPAGOID').AsString +
                     ''' and UPROID='''+DM1.cdsCambios.FieldByName('UPROID').AsString +''' ';
              DM1.cdsQry2.Close;
              DM1.cdsQry2.DataRequest(xSql);
              DM1.cdsQry2.Open;
              if DM1.cdsQry2.RecordCount>= 1 then
              begin
                 DM1.cdsCambios.Edit;
                 DM1.cdsCambios.FieldByName('USEID').AsString := DM1.cdsQry2.FieldByName('USEID').AsString ;
                 DM1.cdsCambios.ApplyUpdates(0);
              end;

           end;

           DM1.cdsCambios.Next;
        end
     end;

     DM1.cdsQry1.Next;
  end;

	Screen.Cursor:=crDefault;

end;


//Filtra del CRE310 Aquellas Uses Uproid Upagoid no estan en APO101
procedure TFContabilizacion.FilIncos;
begin
  xSql:='SELECT * FROM '
       + '( Select A.ASOID, A.CREDID, A.CRECUOTA, A.USEID, A.UPROID, A.UPAGOID, B.USEID BUSEID, '
       +      'B.UPROID BUPROID, B.UPAGOID BUPAGOID, B.CCOSID BCCOSID '
       +   'From ( SELECT ASOID, CREDID, CRECUOTA, USEID, UPROID, UPAGOID '
       +          'FROM CRE310 A '
       +          'where '+xWhereBusqueda
       //+          'WHERE FOPERACTMP >= '''+xDiaIni+''' '
       //+            'and FOPERACTMP <= '''+xDiaFin+''' '
       +        ' ) A,'
       +     'APO101 B '
       +   'Where A.USEID=B.USEID(+) AND A.UPROID=B.UPROID(+) AND A.UPAGOID=B.UPAGOID(+) '
       + ') C '
       +'WHERE BUSEID IS NULL';
  DM1.cdsQry1.Close;
  DM1.cdsQry1.DataRequest(xSql);
  DM1.cdsQry1.Open;
end;


//Filtra del CRE310 Aquellas Uses Uproid Upagoid no estan en APO101
procedure TFContabilizacion.FilIncos2;
begin
  xSQL:='SELECT * FROM '
       +  '( SELECT  A.ASOID, A.CREDID, A.CRECUOTA, A.USEID, A.UPROID, A.UPAGOID, B.USEID BUSEID, '
       +       'B.UPROID BUPROID, B.UPAGOID BUPAGOID, B.CCOSID BCCOSID '
       +    'FROM ( SELECT ASOID, CREDID, CRECUOTA, USEID, UPROID, UPAGOID '
       +           'From CRE310 A '
       +           'where '+xWhereBusqueda
       //+           'where FORPAGID=''03'' '
       //+             'and FREG>='''+xDiaIni+''' AND FREG<='''+xDiaFin+''' '
       +             'and CREESTID<>''13'' and CREESTID<>''04'' '
       +             'and CREDOCPAG is not null '
       +             'and BANCOID is not null '
       +             'and CCBCOID is not null '
       +          ') A, APO101 B '
       +    'WHERE A.USEID=B.USEID(+) AND A.UPROID=B.UPROID(+) AND A.UPAGOID=B.UPAGOID(+) '
       + ') C '
       +'WHERE BUSEID IS NULL ';
  DM1.cdsQry1.Close;
  DM1.cdsQry1.DataRequest(XsQL);
  DM1.cdsQry1.Open;
end;


//Filtr de CRE310 Aquellas uses uproid upagoid no estan en APO101
procedure TFContabilizacion.FilIncos3;
begin
  xSql:='SELECT * from '
       +  '( Select A.ASOID, A.CREDID, A.CRECUOTA, A.USEID, A.UPROID, A.UPAGOID, B.USEID BUSEID, '
       +       'B.UPROID BUPROID, B.UPAGOID BUPAGOID, B.CCOSID BCCOSID '
       +    'From ( SELECT ASOID, CREDID, CRECUOTA, USEID, UPROID, UPAGOID '
       +           'FROM CRE310 A '
       +           'where '+xWhereBusqueda
       //+           'WHERE TIPOCONT=''PLA'' '
       //+             'AND FREG>='''+xDiaIni+''' AND FREG<='''+xDiaFin+''' '
       +             'AND CREESTID<>''13'' AND CREESTID<>''04'' AND CREESTID<>''99'' '
       +          ') A, APO101 B '
       +    'WHERE A.USEID=B.USEID(+) AND A.UPROID=B.UPROID(+) AND A.UPAGOID=B.UPAGOID(+) '
       +  ') C '
       +'WHERE BUSEID IS NULL';
  DM1.cdsQry1.Close;
  DM1.cdsQry1.DataRequest(xSql);
  DM1.cdsQry1.Open;
end;


procedure TFContabilizacion.bbtnBolDInconsClick(Sender: TObject);
begin
  bError:=True;
  ParametrosBoleta;
  xSQL:='SELECT ASOID, ASOCODMOD, ASOAPENOM, CREDID, CRECUOTA, CREMTOCOB, CREAMORT, CREINTERES, CREFLAT, CREMTOEXC, '
       +   'NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0)) DIFERENCIA, '
       +   'CREMTODEV '
       +'From CRE310 A '
       +'where '+xWhereBusqueda
       //+'Where A.FORPAGID=''03'' '
       //+  'and A.FREG>='+quotedstr( xDiaIni )+' and A.FREG<='+quotedstr( xDiaFin )+' '
       +  'and CREESTID<>''13'' and CREESTID<>''99'' '
       +  'and CREDOCPAG is not null '
       +  'and A.BANCOID is not null '
       +  'and A.CCBCOID is not null '
       +  'and (NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0))<>0 '
       +   'or NVL(CREAMORT,0)<0 or NVL(CREINTERES,0)<0 or NVL(CREFLAT,0)<0)';
  ImprimeInconsistenciaPagosCRE310( xSQL );
  if bError then
     ShowMessage('ok');
end;

procedure TFContabilizacion.bbtnTeleInconsClick(Sender: TObject);
begin
  bError:=True;
  ParametrosTeleahorro;
  xSQL:='Select ASOID, ASOCODMOD, ASOAPENOM, CREDID, CRECUOTA, CREMTOCOB, CREAMORT, CREINTERES, CREFLAT, CREMTOEXC, '
       +   'NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0)) DIFERENCIA,'
       +   'CREMTODEV '
       +'From CRE310 A '
       +'where '+xWhereBusqueda
       //+'Where FOPERACTMP>='''+xDiaIni+''' and FOPERACTMP<='''+xDiaFin+''' '
       +  'AND CREESTID<>''13'' AND CREESTID<>''99'' '
       +  'and (NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0)))<>0';
  ImprimeInconsistenciaPagosCRE310( xSQL );
  if bError then
     ShowMessage('ok');
end;

procedure TFContabilizacion.bbtnPlanInconsClick(Sender: TObject);
var
   xSQLPla : String;
begin
  bError:=True;

  ParametrosPlanilla;
  UpdatePlanilla;
  
  xSQL:='Select ASOID, ASOCODMOD, ASOAPENOM, CREDID, CRECUOTA, CREMTOCOB, CREAMORT, CREINTERES, CREFLAT, CREMTOEXC, '
       +  'NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0)) DIFERENCIA, '
       +  'CREMTODEV '
       +'From CRE310 A '
       +'where '+xWhereBusqueda
       //+'Where (forpagabr=''PLA'' OR FORPAGABR=''REG'' OR FORPAGABR=''CEF'' )'
       //+ ' and CNTANOMM=''200411'' '
       + ' and CREESTID<>''13'' AND CREESTID<>''99'''
       + ' and (NVL(CREMTOCOB,0)-(NVL(CREAMORT,0)+NVL(CREINTERES,0)+NVL(CREFLAT,0)+NVL(CREMTOEXC,0))<>0 '
       + ' or NVL(CREAMORT,0)<0 or NVL(CREINTERES,0)<0 or NVL(CREFLAT,0)<0)';
  ImprimeInconsistenciaPagosCRE310( xSQL );
  if bError then
     ShowMessage('ok');
end;

procedure TFContabilizacion.TransferirContabilidad(cLote,cOrigen,xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r : String);
var
   xSQL, xNumMax, xNumMin : String;

   NumComp, NumCompAnt : String;
begin
   If MessageDlg('¿Está Seguro de Transferir Contabilidad ( '+cLote+ ' ) ?',mtconfirmation,[mbYes,MbNo],0)=mrNo then
      Begin
         Screen.Cursor:=crDefault;
         Exit;
      end;

   Screen.Cursor:=crHourGlass;

   ///
   xSQL:='Select * from CNT300 '
        +'where CIAID>=''02'' AND TDIARID='''+cOrigen+''' and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%''';
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );
   try
     DM1.cdsQry2.Open;
   except
   end;

   if DM1.cdsQry2.Recordcount>0 then
   begin
      If MessageDlg('Asientos Generados fueron Transferidos a Contabilidad. ¿Desea Eliminar Asientos Transferidos?',mtconfirmation,[mbYes,MbNo],0)=mrNo then
      Begin
         Screen.Cursor:=crDefault;
         Exit;
      end;

      xSQL:='Select * from CNT300 '
           +'where CIAID>=''02'' AND TDIARID='''+cOrigen+''' and CNTANOMM='''+xPeriodo+''' '
           +  'and CNTLOTE='''+cLote+'%'' and CNTESTADO=''P'' AND CNTCUADRE=''S''';
      DM1.cdsQry2.Close;
      DM1.cdsQry2.DataRequest( xSQL );
      try
         DM1.cdsQry2.Open;
      except
      end;

      if DM1.cdsQry2.Recordcount>0 then
      begin
         Screen.Cursor:=crDefault;
         MessageDlg('Asientos ya fueron Aceptados por Contabilidad. NO se pueden Eliminar !!!', mtError, [mbOk], 0);
         Exit
      end;
   end;
   ///

   xSQL:='Select * from '+xCnt300r+' '
        +'where CIAID>=''02'' AND TDIARID in ('''+cOrigen+''',''30'') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' ';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest( xSQL );
   try
      DM1.cdsQry.Open;
   except
      Exit;
   end;

   if DM1.cdsQry.RecordCount>0 Then
   begin
      If MessageDlg('Existen Registros Transferidos de Cobranzas. ¿Desea continuar con Transferencia?',mtconfirmation,[mbYes,MbNo],0)=mrNo then
      Begin
         Screen.Cursor:=crDefault;
         Exit;
      end;
      xSQL:='Delete from '+xCnt300r+' '
           +'where CIAID>=''02'' AND TDIARID in (''30'','''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
           +  'and CNTLOTE LIKE '''+cLote+'%'' ';
      DM1.cdsQry2.Close;
      DM1.cdsQry2.DataRequest( xSQL );
      try
         DM1.cdsQry2.Execute;
      except
      end;

      xSQL:='Delete from '+xCnt311r+' '
           +'where CIAID>=''02'' AND TDIARID in (''30'','''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
           +  'and CNTLOTE LIKE '''+cLote+'%'' ';
      DM1.cdsQry2.Close;
      DM1.cdsQry2.DataRequest( xSQL );
      try
         DM1.cdsQry2.Execute;
      except
      end;


      xSQL:='Delete from CNT301 '
           +'where CIAID>=''02'' AND TDIARID in (''30'','''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
           +  'and CNTLOTE LIKE '''+cLote+'%'' ';
      DM1.cdsQry2.Close;
      DM1.cdsQry2.DataRequest( xSQL );
      try
         DM1.cdsQry2.Execute;
      except
      end;

   end;
   // Para poder obtener el xNumMin y xNumMax


   //PARA RENUMERAR ORIGEN 32
   xSQL:='SELECT NVL(MAX( CNTCOMPROB ),''0'') NUMMAX, NVL(MIN( CNTCOMPROB ),''0'') NUMMIN '
        +'FROM '+xCNT311+' '
        +'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID in ('''+cOrigen+''') '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   xNumMax:=DM1.cdsQry.FieldByName('NUMMAX').AsString;
   xNumMin:=DM1.cdsQry.FieldByName('NUMMIN').AsString;


   //COD BERGER
   xSQL:='select NVL(MAX( CNTCOMPROB ),''0'') MAXIMO FROM '+xCnt300r+' '
        +'where CIAID>=''02'' AND TDIARID in ('''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
        +'order by CIAID, TDIARID, CNTCOMPROB';
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );
   try
      DM1.cdsQry2.oPEN;
   except
   end;
   //NUMCOMP:=inttostr(DM1.cdsQry2.recordcount);
   NUMCOMP:=DM1.cdsQry2.FieldByName('MAXIMO').ASSTRING;
   NUMCOMP:= DM1.strzero(inttostr(strtoint(numcomp)+1),10);
   NUMCOMPANT:=xNumMin;

   WHILE NUMCOMPANT<=xNumMax do
   BEGIN
      xSQL:='update '+xCnt300+' '
        +'set CNTCOMPROB = '''+NUMCOMP+''' '
        +'where CIAID>=''02'' AND TDIARID in ('''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
	      +  'and CNTCOMPROB='''+NUMCOMPANT+''' ';
      DM1.cdsQry.Close;
      DM1.cdsQry.DataRequest( xSQL );
      try
         DM1.cdsQry.Execute;
      except
      end;

      xSQL:='update '+xCnt311+' '
        +'set CNTCOMPROB = '''+NUMCOMP+''' '
        +'where CIAID>=''02'' AND TDIARID in ('''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +  'and CNTCOMPROB='''+NUMCOMPANT+''' ';
      DM1.cdsQry.Close;
      DM1.cdsQry.DataRequest( xSQL );
      try
         DM1.cdsQry.Execute;
      except
      end;
      NUMCOMP:=DM1.strzero(inttostr(strtoint(NUMCOMP)+1),10);
      NUMCOMPANT:=DM1.strzero(inttostr(strtoint(NUMCOMPANT)+1),10);
    END;

    // Renumerar Origen 30
   //PARA RENUMERAR ORIGEN 30
   xSQL:='SELECT NVL(MAX( CNTCOMPROB ),''0'') NUMMAX, NVL(MIN( CNTCOMPROB ),''0'') NUMMIN '
        +'FROM '+xCNT300+' '
        +'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID in (''30'') '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   xNumMax:=DM1.cdsQry.FieldByName('NUMMAX').AsString;
   xNumMin:=DM1.cdsQry.FieldByName('NUMMIN').AsString;


   //COD BERGER
   xSQL:='select NVL(MAX( CNTCOMPROB ),''0'') MAXIMO FROM '+xCnt300r+' '
        +'where CIAID>=''02'' AND TDIARID in (''30'') and CNTANOMM='''+xPeriodo+''' '
        +'order by CIAID, TDIARID, CNTCOMPROB';
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );
   try
      DM1.cdsQry2.oPEN;
   except
   end;
   //NUMCOMP:=inttostr(DM1.cdsQry2.recordcount);
   NUMCOMP:=DM1.cdsQry2.FieldByName('MAXIMO').ASSTRING;
   NUMCOMP:= DM1.strzero(inttostr(strtoint(numcomp)+1),10);
   NUMCOMPANT:=xNumMin;

   WHILE NUMCOMPANT<=xNumMax do
   BEGIN
      xSQL:='update '+xCnt300+' '
        +'set CNTCOMPROB = '''+NUMCOMP+''' '
        +'where CIAID>=''02'' AND TDIARID in (''30'') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
	      +  'and CNTCOMPROB='''+NUMCOMPANT+''' ';
      DM1.cdsQry.Close;
      DM1.cdsQry.DataRequest( xSQL );
      try
         DM1.cdsQry.Execute;
      except
      end;

      xSQL:='update '+xCnt311+' '
        +'set CNTCOMPROB = '''+NUMCOMP+''' '
        +'where CIAID>=''02'' AND TDIARID in (''30'') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +  'and CNTCOMPROB='''+NUMCOMPANT+''' ';
      DM1.cdsQry.Close;
      DM1.cdsQry.DataRequest( xSQL );
      try
         DM1.cdsQry.Execute;
      except
      end;
      NUMCOMP:=DM1.strzero(inttostr(strtoint(NUMCOMP)+1),10);
      NUMCOMPANT:=DM1.strzero(inttostr(strtoint(NUMCOMPANT)+1),10);
    END;

   // FIN COD BERGER

   // Valida si no hay repetidos antes de insertarlos en la tabla xCnt300r
    // origen 32
    xSQL:='SELECT MAX( CNTCOMPROB ) NUMMAX, MIN( CNTCOMPROB ) NUMMIN FROM '+xCNT311+' '
        +'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID in ('''+cOrigen+''') '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   xNumMax:=DM1.cdsQry.FieldByName('NUMMAX').AsString;
   xNumMin:=DM1.cdsQry.FieldByName('NUMMIN').AsString;

   xSQL:='SELECT * FROM '+xCnt300r+' '
        +'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID in ('''+cOrigen+''') '
        +  'AND CNTCOMPROB BETWEEN '''+xNumMin+''' AND '''+xNumMax+''' '
        +'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   if DM1.cdsQry.RecordCount>0 Then
   begin
      MessageDlg('Error : En Contabilidad existen comprobantes con el mismo Numero, Debe volver a Transferir Contabilidad !!!', mtError, [mbOk], 0);
      Exit;
   end;

   // origen 30
    xSQL:='SELECT NVL(MAX( CNTCOMPROB ),''0'') NUMMAX, NVL(MIN( CNTCOMPROB ),''0'') NUMMIN '
        + 'FROM '+xCNT311+' '
        + 'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +   'AND TDIARID in (''30'') '
        +   'and CNTLOTE LIKE '''+cLote+'%'' '
        + 'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   xNumMax:=DM1.cdsQry.FieldByName('NUMMAX').AsString;
   xNumMin:=DM1.cdsQry.FieldByName('NUMMIN').AsString;

   xSQL:='SELECT * FROM '+xCnt300r+' '
        +'WHERE CIAID=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID in (''30'') '
        +  'AND CNTCOMPROB BETWEEN '''+xNumMin+''' AND '''+xNumMax+''' '
        +'ORDER BY TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   if DM1.cdsQry.RecordCount>0 Then
   begin
      MessageDlg('Error : En Contabilidad existen comprobantes con el mismo Numero, Debe volver a Transferir Contabilidad !!!', mtError, [mbOk], 0);
      Exit;
   end;

   // transferir
   xSQL:='insert into '+xCnt300r+' '
        +'select * from '+xCNT300+' '
        +'where CIAID>=''02'' AND TDIARID in (''30'','''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +'order by CIAID, TDIARID, CNTCOMPROB';
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );
   try
      DM1.cdsQry2.Execute;
   except
   end;

   xSQL:='insert into '+xCnt311r+' '
        +'select * from '+xCNT311+' '
        +'where CIAID>=''02'' AND TDIARID in (''30'','''+cOrigen+''') and CNTANOMM='''+xPeriodo+''' '
        +  'and CNTLOTE LIKE '''+cLote+'%'' '
        +'order by CIAID, TDIARID, CNTCOMPROB';
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );
   try
      DM1.cdsQry2.Execute;
   except
   end;


   {
   DM1.cdsQry2.Close;
   DM1.cdsQry2.DataRequest( xSQL );

   try
     if cLote='DOFI' then
     begin
        //--ACTUALIZA FLAG CONTB. OFICIOS
        xSQL:='UPDATE CRE301 SET CNTFLAG=''S'',CNTANOMM='''+xPeriodo+''',TIPOCONT=''DOFI'' '
             +'WHERE CREFOTORG BETWEEN To_Date('+QuotedStr(DateToStr(DtpFecIni.Date))+',''dd/mm/yyyy'') '
             +  'AND To_Date('+QuotedStr(DateToStr(DtpFecFin.Date))+',''dd/mm/yyyy'') '
             +  'AND TIPDESEID IN (''05'',''06'',''09'') AND CREESTID<>''13''';
        DM1.cdsQry2.DataRequest( xSQL );
        DM1.cdsQry2.Execute;
     end;
     if cLote='DCAJ' then
     begin
        //--ACTUALIZA FLAG CONTB. DESEMBOLSO EN EFECTIVO
        xSQL:='UPDATE CRE301 SET CNTFLAG=''S'',CNTANOMM='''+xPeriodo+''',TIPOCONT=''DEFE'' '
             +'WHERE CREFOTORG BETWEEN To_Date('+QuotedStr(DateToStr(DtpFecIni.Date))+',''dd/mm/yyyy'') '
             +  'AND To_Date('+QuotedStr(DateToStr(DtpFecFin.Date))+',''dd/mm/yyyy'') '
             +  'AND TIPDESEID IN (''04'') AND CREESTID<>''13''';
        DM1.cdsQry2.DataRequest( xSQL );
        DM1.cdsQry2.Execute;
     end;
   except
   end;
   }
   Screen.Cursor:=crDefault;
   MessageDlg('La Transferencia Exitosa !!!', mtConfirmation, [mbOk], 0);
end;

procedure TFContabilizacion.BitBtn1Click(Sender: TObject);
begin
   ParametrosTeleahorro;
   TransferirContabilidad( 'TEL', '32',xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r);
end;


procedure TFContabilizacion.ReporteContabilizaCredito( cTabla, cLote,xPeriodo : String);
var
   xSQL : String;
begin
   Screen.Cursor:=crHourGlass;

   xSQL:='SELECT CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CUENTAID, DOCID, CNTSERIE, '
        +  'CNTNODOC, AUXID, CCOSID, sum( CNTDEBEMN ) CNTDEBEMN, sum( CNTHABEMN ) CNTHABEMN '
        +'FROM '+cTabla+' '
        +'WHERE CIAID>=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID IN ( ''32'',''30'', ''35'' ) AND CNTLOTE LIKE '''+cLote+'%'' '
        +'GROUP BY CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CUENTAID, DOCID, CNTSERIE, AUXID, CCOSID, CNTNODOC '
        +'ORDER BY CIAID, TDIARID, CNTCOMPROB';
   xSQL:='SELECT CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CUENTAID, DOCID, CNTSERIE, '
        +  'CNTNODOC, sum( CNTDEBEMN ) CNTDEBEMN, sum( CNTHABEMN ) CNTHABEMN '
        +'FROM '+cTabla+' '
        +'WHERE CIAID>=''02'' AND CNTANOMM = '''+xPeriodo+''' '
        +  'AND TDIARID IN ( ''32'',''30'',''35'' ) AND CNTLOTE LIKE '''+cLote+'%'' '
        +'GROUP BY CIAID, TDIARID, CNTANOMM, CNTCOMPROB, CUENTAID, DOCID, CNTSERIE, CNTNODOC '
        +'ORDER BY CIAID, TDIARID, CNTCOMPROB';
   DM1.cdsQry.Close;
   DM1.cdsQry.DataRequest(xSQL);
   DM1.cdsQry.Open;

   Screen.Cursor:=crDefault;
  If DM1.cdsQry.RecordCount>0 Then
  begin
     ppdb1.DataSource :=nil;
     ppr1.DataPipeline:=nil;
     //ppr1.Template.FileName:='CreditosConta.rtm';
     //ppr1.Template.LoadFromFile;
     ppdb1.DataSource :=DM1.dsQry;
     ppr1.DataPipeline:=ppdb1;
     //ppd1.ShowModal;
     ppr1.Print;
     ppr1.Stop;
     ppdb1.DataSource :=nil;
     ppr1.DataPipeline:=nil;
  end
  else
  begin
     if cTabla='CNT311' then
     begin
        xSQL:='SELECT * FROM CNT300 '
             +'WHERE CIAID>=''02'' AND CNTANOMM = '''+xPeriodo+''' '
             +  'AND TDIARID IN ( ''32'',''30'' ) AND CNTLOTE LIKE '''+cLote+'%'' '
             +  'AND CNTESTADO=''P'' AND CNTCUADRE=''S'' '
             +'ORDER BY CIAID, TDIARID, CNTCOMPROB';
        DM1.cdsQry.Close;
        DM1.cdsQry.DataRequest(xSQL);
        DM1.cdsQry.Open;

        If DM1.cdsQry.RecordCount>0 Then
        begin
           ShowMessage('Transferencia ya fue Aceptada por Contabilidad');
           xSQL:='SELECT * FROM CNT301 '
                +'WHERE CIAID>=''02'' AND CNTANOMM = '''+xPeriodo+''' '
                +  'AND TDIARID IN ( ''32'',''30'' ) AND CNTLOTE LIKE '''+cLote+'%'' '
                +'ORDER BY CIAID, TDIARID, CNTCOMPROB, CNTREG';
           DM1.cdsQry.Close;
           DM1.cdsQry.DataRequest(xSQL);
           DM1.cdsQry.Open;
           ppdb1.DataSource :=nil;
           ppr1.DataPipeline:=nil;
           //ppr1.Template.FileName:='CreditosConta.rtm';
           //ppr1.Template.LoadFromFile;
           ppdb1.DataSource :=DM1.dsQry;
           ppr1.DataPipeline:=ppdb1;
           //ppd1.ShowModal;
           ppr1.Print;
           ppr1.Stop;
           ppdb1.DataSource :=nil;
           ppr1.DataPipeline:=nil;
        end
        else
           ShowMessage('No se ha Transferido Contabilización');

     end
     else
        ShowMessage('No se ha Generado Contabilización')
  end;
end;


procedure TFContabilizacion.BitBtn6Click(Sender: TObject);
begin
  ParametrosPlanilla;
  TransferirContabilidad( 'PLA', '32',xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r);
end;


procedure TFContabilizacion.BitBtn7Click(Sender: TObject);
begin
//  TransferirContabilidad( 'BOL', '32',xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r);
  TransferirContabilidad( 'BOL', '35',xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r);
end;

procedure TFContabilizacion.bbtnEfeTransClick(Sender: TObject);
begin
      TransferirContabilidad( 'EFE', '32',xPeriodo,xCnt300,xCnt311,xCnt300r,xCnt311r);
end;

procedure TFContabilizacion.fcShapeBtn3Click(Sender: TObject);
begin
   ParametrosTeleahorro;
   ReporteContabilizaCredito( xCnt311r, 'TEL',xPeriodo );
end;

procedure TFContabilizacion.fcShapeBtn4Click(Sender: TObject);
begin
   ParametrosPlanilla;
   ReporteContabilizaCredito( xCnt311, 'PLA', xPeriodo  );
end;

procedure TFContabilizacion.fcShapeBtn5Click(Sender: TObject);
begin
   ParametrosPlanilla;
   ReporteContabilizaCredito( xCnt311r, 'PLA',xPeriodo  );
end;

procedure TFContabilizacion.fcShapeBtn8Click(Sender: TObject);
begin
    ReporteContabilizaCredito( xCnt311r, 'BOL',xPeriodo );
end;

procedure TFContabilizacion.fcShapeBtn9Click(Sender: TObject);
begin
    ReporteContabilizaCredito( xCnt311r, 'EFE',xPeriodo );
end;


procedure TFContabilizacion.ImprimeInconsistenciaVerificaCuentaCCosto( cSQL : String );
begin
   Screen.Cursor:=crHourGlass;
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(cSQL);
   DM1.cdsQry3.Open;
   if DM1.cdsQry3.RecordCount>0 then //q solo sea ">"
   begin
      ppdb5.DataSource :=nil;
      ppr5.DataPipeline:=nil;
      //ppr5.Template.FileName:='CobInconsistencia.rtm';
      //ppr5.Template.LoadFromFile;
      lblperiodo.Caption:= dbsemes.Text  + ' / ' + dbseano.Text;
      ppdb5.DataSource :=DM1.dsQry3;
      ppr5.DataPipeline:=ppdb5;
      Screen.Cursor:=crDefault;
      //ppd5.ShowModal;
      ppr5.Print;
      ppr5.Stop;
      ppdb5.DataSource :=nil;
      ppr5.DataPipeline:=nil;
      bError:=False;
   end;
   Screen.Cursor:=crDefault;
end;


procedure TFContabilizacion.ImprimeInconsistenciaPagosCRE310( cSQL : String );
begin
   Screen.Cursor:=crHourGlass;
   DM1.cdsQry3.Close;
   DM1.cdsQry3.Filter:='';
   DM1.cdsQry3.Filtered:=False;
   DM1.cdsQry3.IndexFieldNames:='';
   DM1.cdsQry3.DataRequest(cSQL);
   DM1.cdsQry3.Open;
   if DM1.cdsQry3.RecordCount>0 then //q solo sea ">"
   begin
      ppdb6.DataSource :=nil;
      ppr6.DataPipeline:=nil;
      ppr6.Template.FileName:='CobInconsistenciaCRE310.rtm';
      ppr6.Template.LoadFromFile;
      pplPeriodo6.Caption:= dbsemes.Text  + ' / ' + dbseano.Text;
      ppdb6.DataSource :=DM1.dsQry3;
      ppr6.DataPipeline:=ppdb6;
      ppd6.ShowModal;
    	Screen.Cursor:=crDefault;
      //ppr6.Print;
      ppr6.Stop;
      ppdb6.DataSource :=nil;
      ppr6.DataPipeline:=nil;
      bError:=False;
   end;
   Screen.Cursor:=crDefault;
end;

procedure TFContabilizacion.TabSheet5Enter(Sender: TObject);
begin
   wTipoCont := 'PL';
   wTipoCont2 := 'PLA';
   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';

end;

procedure TFContabilizacion.TabSheet7Enter(Sender: TObject);
begin
   wTipoCont := 'EF';
   wTipoCont2 := 'EFE';
   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';
end;

procedure TFContabilizacion.bbtnTELSustentoClick(Sender: TObject);
begin
   ParametrosTeleahorro;
   Screen.Cursor:=crHourGlass;

xSql := 'SELECT  TO_CHAR(A.FREG,''MM/YYYY'') FREG,'+
        'A.UPROID,'+
        'A.USEID,'+
        'A.ASOID,'+
        'SUBSTR(A.CREDID,9,7) CREDID,'+
        'A.CREDOCPAG,'+
        'MIN(A.ASOAPENOM) ASOAPENOM,'+
        'MIN(C.UPRONOM) UPRONOM,'+
        'MIN(B.USENOM) USENOM,'+
        'MIN(B.CCOSID) CCOSID,'+
        'MIN(A.TIPCREID) TIPCREID,'+
        'MIN(D.TIPCREDES) TIPCREDES,'+
        'MIN(A.BANCOID) BANCOID,'+
        'MIN(E.BANCONOM) BANCONOM,'+
        'MAX(A.CCBCOID) CCBCOID,'+
        'MIN(A.FOPERAC) FOPERAC,'+
        'SUM(NVL(A.CREMTOCOB,0)) CREMTOCOB,'+
        'SUM(NVL(A.CREAMORT,0)) CREAMORT,'+
        'SUM(NVL(A.CREINTERES,0)) CREINTERES,'+
        'SUM(NVL(A.CREFLAT,0)) CREFLAT,'+
        'SUM(NVL(A.CREMTOEXC,0)) CREMTOEXC '+
  'FROM CRE310 A,'+
        '(SELECT UPROID,USEID,MAX(CCOSID) CCOSID,MAX(USENOM) USENOM FROM APO101 GROUP BY UPROID,USEID) B,'+
        'APO102 C,'+
        'CRE110 D,'+
        'TGE105 E '+
  'where '+xWhereBusqueda
  //'WHERE A.FOPERACTMP >= ''01'+copy(edtFecha.Text,3,8)+
  //      ''' and A.FOPERACTMP <= '''+ edtFecha.Text +
        +' and A.UPROID=B.UPROID(+) AND '+
        'A.USEID=B.USEID(+) and '+
        'A.UPROID = C.UPROID (+) and '+
        'A.TIPCREID=D.TIPCREID (+)  and '+
        'A.BANCOID=E.BANCOID (+)  '+
   'GROUP BY TO_CHAR(A.FREG,''MM/YYYY''),A.UPROID,A.USEID,A.ASOID,A.CREDID,A.CREDOCPAG '+
   'ORDER BY TO_CHAR(A.FREG,''MM/YYYY''),A.UPROID,A.USEID,A.CREDOCPAG ';
  dm1.cdsQry1.Close;
  dm1.cdsQry1.DataRequest(xSql);
  dm1.cdsQry1.Open;
  BDEPPBANCO.DataSource:=  DM1.dsQry1;
  ppXtitulo.Caption    := 'COBRANZA POR TELEAHORRO CONTABILIZADOS EN EL MES DE '+xMesDes+' DEL '+dbseAno.Text;
  ppXsubtitulo.Caption := 'COBRANZA POR TELEAHORRO DEL MES DE';
  Screen.Cursor:=crDefault;
  REPBANCO.Print;
end;

procedure TFContabilizacion.fcShapeBtn1Click(Sender: TObject);
begin
   ParametrosTeleahorro;
   ReporteContabilizaCredito( xCnt311, 'TEL', xPeriodo );
end;

procedure TFContabilizacion.ParametrosTeleahorro;
begin
   dbseMes.Text := DM1.StrZero(dbseMes.Text,2);
   DatosFecha;
   wTipoCont := 'TE';
   wTipoCont2:= 'TEL';
   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';
end;

procedure TFContabilizacion.ParametrosPlanilla;
begin
   dbseMes.Text := DM1.StrZero(dbseMes.Text,2);
   DatosFecha;
   wTipoCont := 'PL';
   wTipoCont2:= 'PLA';
   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';
end;

procedure TFContabilizacion.ParametrosBoleta;
begin
   dbseMes.Text := DM1.StrZero(dbseMes.Text,2);
   DatosFecha;
   wTipoCont := 'BO';
   wTipoCont2 := 'BOL';
   xWhereBusqueda:=' A.CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)+' '
                  +' and A.TIPOCONT='+quotedstr( wTipoCont2 )+' ';
end;


procedure TFContabilizacion.UpdatePlanilla;
begin
   xSQL:='Update CRE310 SET TIPOCONT=''PLA'' '
        +'where CNTANOMM='+quotedstr(dbseAno.text+dbseMes.text)
        +' and TIPOCONT in ( ''REG'', ''CEF'' )';
   dm1.cdsQry1.Close;
   dm1.cdsQry1.DataRequest(xSQL);
   dm1.cdsQry1.Execute;
end;

procedure TFContabilizacion.BitBtn5Click(Sender: TObject);
var
  xSql, xAnoMes : string;
begin
   ParametrosPlanilla;
   Screen.Cursor:=crHourGlass;

   xSql:='SELECT  TO_CHAR(A.FREG,''MM/YYYY'') FREG,'+
        'CASE  WHEN A.FORPAGABR=''PLA'' THEN ''PLANILLA MINISTERIAL'' '+
        '      WHEN A.FORPAGABR=''REG'' THEN ''PLANILLA REGIONAL'' '+
        '      WHEN A.FORPAGABR=''CEF'' THEN ''ESCUELA FISCALIZADA'' END AS FORPAGABR,'+
        'A.UPROID,'+
        'A.USEID,'+
        'A.ASOID,'+
        'SUBSTR(A.CREDID,9,7) CREDID,'+
        'A.CREDOCPAG,'+
        'MAX(A.CREANO||''-''||A.CREMES) PERCUO,'+
        'MIN(A.ASOAPENOM) ASOAPENOM,'+
        'MIN(C.UPRONOM) UPRONOM,'+
        'MIN(B.USENOM) USENOM,'+
        'MIN(B.CCOSID) CCOSID,'+
        'MIN(A.TIPCREID) TIPCREID,'+
        'MIN(D.TIPCREDES) TIPCREDES,'+
        'MIN(A.BANCOID) BANCOID,'+
        'MIN(E.BANCONOM) BANCONOM,'+
        'MAX(A.CCBCOID) CCBCOID,'+
        'MIN(A.CREFPAG) FOPERAC,'+
        'SUM(NVL(A.CREMTOCOB,0)) CREMTOCOB,'+
        'SUM(NVL(A.CREAMORT,0)) CREAMORT,'+
        'SUM(NVL(A.CREINTERES,0)) CREINTERES,'+
        'SUM(NVL(A.CREFLAT,0)) CREFLAT,'+
        'SUM(NVL(A.CREMTOEXC,0)) CREMTOEXC '+
  'FROM CRE310 A, '+
       '(SELECT UPROID,USEID,MAX(CCOSID) CCOSID,MAX(USENOM) USENOM FROM APO101 GROUP BY UPROID,USEID) B, '+
       'APO102 C, '+
       'CRE110 D, '+
       'TGE105 E  '
       +'where '+xWhereBusqueda
//  'WHERE (forpagabr=''PLA'' OR FORPAGABR=''REG'' OR FORPAGABR=''CEF'')  and '+
//        'CNTANOMM='''+ xAnoMes +''' and '+
       +' AND CREESTID<>''13''  and '+
        'CREESTID<>''04''  and '+
        'A.UPROID=B.UPROID(+) AND '+
        'A.USEID=B.USEID(+) and '+
        'A.UPROID = C.UPROID (+) and '+
        'A.TIPCREID=D.TIPCREID (+)  and '+
        'A.BANCOID=E.BANCOID (+)  and  '+
        'A.CIAID=''02'' '+
   'GROUP BY forpagabr,TO_CHAR(A.FREG,''MM/YYYY''),A.UPROID,A.USEID,A.ASOID,A.CREDID,A.CREDOCPAG '+
   'ORDER BY forpagabr,TO_CHAR(A.FREG,''MM/YYYY''),A.UPROID,A.USEID,A.CREDOCPAG ';

  dm1.cdsQry1.Close;
  dm1.cdsQry1.DataRequest(xSql);
  dm1.cdsQry1.Open;
  BDEPPBANCO.DataSource :=  DM1.dsQry1;
  Xtitulo3.Caption := 'CUOTAS POR PLANILLA CONTABILIZADOS EN EL MES DE '+xMesDes+' DEL '+dbseAno.Text;
  Xsubtitulo3.Caption := 'CUOTAS POR PLANILLA DEL MES DE';
  REPPLA.Print;


end;

procedure TFContabilizacion.BitBtn8Click(Sender: TObject);
VAR
   xSql,xSql2,xAnoMes,VMES:string ;
   xmes:integer;
begin
   ParametrosBoleta;
   Screen.Cursor:=crHourGlass;

   xSql := 'SELECT  A.FOPERAC,'+
           'A.UPROID,'+
           'A.USEID,'+
           'A.ASOID,'+
           'SUBSTR(A.CREDID,9,7) CREDID,'+
           'A.CREDOCPAG,'+
           'TO_CHAR(MIN(A.FOPERAC),''MM/YYYY'') FOP,'+
           'MIN(A.ASOAPENOM) ASOAPENOM,'+
           'MIN(C.UPRONOM) UPRONOM,'+
           'MIN(B.USENOM) USENOM,'+
           'MIN(B.CCOSID) CCOSID,'+
           'MIN(A.TIPCREID) TIPCREID,'+
           'MIN(D.TIPCREDES) TIPCREDES,'+
           'MIN(A.BANCOID) BANCOID,'+
           'MIN(E.BANCONOM) BANCONOM,'+
           'MAX(A.CCBCOID) CCBCOID,'+
           'SUM(NVL(A.CREMTOCOB,0)) CREMTOCOB,'+
           'SUM(NVL(A.CREAMORT,0)) CREAMORT,'+
           'SUM(NVL(A.CREINTERES,0)) CREINTERES,'+
           'SUM(NVL(A.CREFLAT,0)) CREFLAT,'+
           'SUM(NVL(A.CREMTOEXC,0)) CREMTOEXC '+
           'FROM CRE310 A,'+
                '(SELECT UPROID,USEID,MAX(CCOSID) CCOSID,MAX(USENOM) USENOM FROM APO101 GROUP BY UPROID,USEID) B,'+
                'APO102 C,'+
                'CRE110 D,'+
                'TGE105 E  '
         +'where '+xWhereBusqueda
         // 'WHERE A.FORPAGID=''03'' and '+
         //       'CNTANOMM='''+ xAnoMes +''' and '+
                +' and CREDOCPAG is not null  and '+
                'CREESTID<>''13''  and '+
                'CREESTID<>''04''  and '+
                'A.BANCOID is not null  and '+
                'A.CCBCOID is not null  and '+
                'A.UPROID=B.UPROID(+) AND '+
                'A.USEID=B.USEID(+) and '+
                'A.UPROID = C.UPROID (+) and '+
                'A.TIPCREID=D.TIPCREID (+)  and '+
                'A.BANCOID=E.BANCOID (+)  and  '+
                'A.CIAID=''02'' '+
         'GROUP BY A.FOPERAC,A.UPROID,A.USEID,A.ASOID,A.CREDID,A.CREDOCPAG '+
         'ORDER BY TO_CHAR(FOPERAC,''MM/YYYY''),CCBCOID,CREDOCPAG ' ;

    xSql2 := 'SELECT TO_CHAR(MIN(A.FOPERAC),''MM/YYYY'') FOP,A.CCBCOID,MAX(B.BANCONOM) BANCO,SUM(NVL(A.CREMTOCOB,0)) TOTAL '+
             ' FROM CRE310 A, TGE105 B '
            + 'where '+xWhereBusqueda
             //'WHERE A.FORPAGID=''03'' and '+
             //     'CNTANOMM='''+ xAnoMes +''' and '+
                  +' and CREDOCPAG is not null  and '+
                  'CREESTID<>''13''  and '+
                  'CREESTID<>''04''  and '+
                  'A.BANCOID is not null  and '+
                  'A.CCBCOID is not null  and '+
                  'A.BANCOID=B.BANCOID(+) '+
             'GROUP BY A.CCBCOID,TO_CHAR(A.FOPERAC,''MM/YYYY'') ' ;

  dm1.cdsQry3.Close;
  dm1.cdsQry3.IndexFieldNames:='FOP;CCBCOID';
  dm1.cdsQry3.DataRequest(xSql);
  dm1.cdsQry3.Open;
  DBPBANCOS.DataSource  := DM1.dsQry3;

  dm1.cdsQry4.Close;
  dm1.cdsQry4.DataRequest(xSql2);
  dm1.cdsQry4.Open;
  DBPRESUMEN.DataSource := DM1.dsQry4;

  ppXtitulo2.Caption   := 'BOLETAS DE DEPOSITO DE BANCOS CONTABILIZADOS EN EL MES DE '+xMesDes+' DEL '+dbseAno.Text;
  ppXsubtitulo2.Caption:= 'BOLETAS DE BANCO FECHA DE OPERACION DEL ' ;
  ppBDEPPBANCO2.Print;

end;

procedure TFContabilizacion.fcShapeBtn7Click(Sender: TObject);
begin
    ReporteContabilizaCredito( xCnt311, 'BOL',xPeriodo );
end;

procedure TFContabilizacion.fcShapeBtn10Click(Sender: TObject);
begin
    ReporteContabilizaCredito( xCnt311, 'EFE',xPeriodo );
end;

procedure TFContabilizacion.BitBtn9Click(Sender: TObject);
begin

   xSQL:='SELECT USUARIO, USERNOM, CREFPAG, SUM(NVL(CREMTOCOB,0)) CREMTOCOB, '
        +   'SUM(NVL(CREAMORT,0)) CREAMORT, SUM(NVL(CREINTERES,0)) CREINTERES, '
        +   'SUM(NVL(CREFLAT,0)) CREFLAT, SUM(NVL(CREMTOEXC,0)) CREMTOEXC, '
        +   '''COBRANZAS EN EFECTIVO DEL MES DE '+xMesDes+' DEL '+dbseAno.Text+''' PERIODO '
        +'FROM CRE310 A, USERTABLE B '
        +'Where '+xWhereBusqueda
        + ' and A.USUARIO=B.USERID '
        + ' and CREESTID<>''13'' AND CREESTID<>''99'' AND CREESTID<>''04'' '
        +'GROUP BY USUARIO,USERNOM,CREFPAG '
        +'ORDER BY USUARIO,USERNOM,CREFPAG ';

   dm1.cdsQry4.Close;
   dm1.cdsQry4.DataRequest(xSQL);
   dm1.cdsQry4.Open;

   ppdb10.DataSource :=nil;
   ppr10.DataPipeline:=nil;
//   ppr10.Template.FileName:='CobranzasEnEfectivo.rtm';
//   ppr10.Template.LoadFromFile;
   ppdb10.DataSource :=  DM1.dsQry4;
   ppr10.DataPipeline:=ppdb10;
   Screen.Cursor:=crDefault;
   //ppd10.ShowModal;
   ppr10.Print;
   ppr5.Stop;
   ppdb5.DataSource :=nil;
   ppr5.DataPipeline:=nil;

end;

end.

